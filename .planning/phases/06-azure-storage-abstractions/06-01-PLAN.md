---
phase: 06-azure-storage-abstractions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj
  - src/Imagile.Framework.Storage/Interfaces/IQueueMessage.cs
  - src/Imagile.Framework.Storage/Interfaces/IBlobContainer.cs
  - src/Imagile.Framework.Storage/Attributes/StorageAccountAttribute.cs
  - Directory.Packages.props
  - Imagile.Framework.sln
autonomous: true

must_haves:
  truths:
    - "Developer can reference Imagile.Framework.Storage package"
    - "IQueueMessage interface has static abstract DefaultQueueName property"
    - "IBlobContainer interface has static abstract DefaultContainerName property"
    - "StorageAccountAttribute allows associating types with named storage accounts"
  artifacts:
    - path: "src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj"
      provides: "Package definition with Azure Storage dependencies"
      contains: "Azure.Storage.Queues"
    - path: "src/Imagile.Framework.Storage/Interfaces/IQueueMessage.cs"
      provides: "Queue message contract with static abstract property"
      contains: "static abstract string DefaultQueueName"
    - path: "src/Imagile.Framework.Storage/Interfaces/IBlobContainer.cs"
      provides: "Blob container contract with static abstract property"
      contains: "static abstract string DefaultContainerName"
    - path: "src/Imagile.Framework.Storage/Attributes/StorageAccountAttribute.cs"
      provides: "Attribute for multi-storage-account association"
      contains: "class StorageAccountAttribute"
  key_links:
    - from: "Imagile.Framework.Storage.csproj"
      to: "Directory.Packages.props"
      via: "central package management"
      pattern: "PackageReference.*Azure\\.Storage"
    - from: "Imagile.Framework.sln"
      to: "Imagile.Framework.Storage.csproj"
      via: "solution project reference"
      pattern: "Imagile\\.Framework\\.Storage"
---

<objective>
Create the Imagile.Framework.Storage package with core interfaces and attributes for Azure Storage abstractions.

Purpose: Establish the package foundation with IQueueMessage and IBlobContainer interfaces using C# 11 static abstract members, enabling type-safe queue/container naming conventions. The StorageAccountAttribute enables multi-storage-account scenarios.

Output: New NuGet package with interfaces and attributes ready for extension methods and DI integration.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-azure-storage-abstractions/06-CONTEXT.md
@.planning/phases/06-azure-storage-abstractions/06-RESEARCH.md
@Directory.Packages.props
@Directory.Build.props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Storage package with Azure dependencies</name>
  <files>
    src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj
    Directory.Packages.props
    Imagile.Framework.sln
  </files>
  <action>
Create the Imagile.Framework.Storage project:

1. Create `src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj`:
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <PackageId>Imagile.Framework.Storage</PackageId>
    <Description>Azure Storage abstractions for .NET applications. Includes type-safe interfaces for Queue and Blob Storage with convention-based initialization and multi-storage-account support.</Description>
    <PackageTags>azure;storage;queue;blob;abstractions;framework</PackageTags>
    <PackageReadmeFile>README.md</PackageReadmeFile>
  </PropertyGroup>

  <ItemGroup>
    <None Include="README.md" Pack="true" PackagePath="\" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Azure.Storage.Queues" />
    <PackageReference Include="Azure.Storage.Blobs" />
    <PackageReference Include="Microsoft.Extensions.Azure" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection.Abstractions" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Imagile.Framework.Configuration\Imagile.Framework.Configuration.csproj" />
  </ItemGroup>

</Project>
```

2. Create `src/Imagile.Framework.Storage/README.md` with basic package description:
```markdown
# Imagile.Framework.Storage

Azure Storage abstractions for .NET applications.

## Features

- **IQueueMessage** - Type-safe queue message contracts with convention-based naming
- **IBlobContainer** - Type-safe blob container contracts with convention-based naming
- **StorageAccountAttribute** - Multi-storage-account support via attributes
- **Convention-based initialization** - Automatic queue/container creation at startup

## Usage

```csharp
// Define a queue message
public class TenantVerificationMessage : IQueueMessage
{
    public static string DefaultQueueName => "tenant-verification";

    public int TenantId { get; set; }
}

// Use type-safe extension
var queue = queueServiceClient.GetQueueClient<TenantVerificationMessage>();
await queue.SendMessageAsync(JsonSerializer.Serialize(message));
```
```

3. Update `Directory.Packages.props` to add Azure Storage package versions (add to Azure section):
```xml
<PackageVersion Include="Azure.Storage.Queues" Version="12.21.0" />
<PackageVersion Include="Azure.Storage.Blobs" Version="12.26.0" />
<PackageVersion Include="Microsoft.Extensions.Azure" Version="1.7.6" />
```

4. Add project to solution:
```bash
dotnet sln Imagile.Framework.sln add src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj
```

5. Build to verify:
```bash
dotnet build src/Imagile.Framework.Storage
```
  </action>
  <verify>
`dotnet build src/Imagile.Framework.Storage` succeeds with 0 errors, 0 warnings.
`dotnet sln Imagile.Framework.sln list` includes Imagile.Framework.Storage.
  </verify>
  <done>
Storage package exists in solution with Azure.Storage.Queues, Azure.Storage.Blobs, and Microsoft.Extensions.Azure dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create IQueueMessage and IBlobContainer interfaces</name>
  <files>
    src/Imagile.Framework.Storage/Interfaces/IQueueMessage.cs
    src/Imagile.Framework.Storage/Interfaces/IBlobContainer.cs
  </files>
  <action>
Create interfaces using C# 11 static abstract members pattern from imagile-app:

1. Create `src/Imagile.Framework.Storage/Interfaces/IQueueMessage.cs`:
```csharp
namespace Imagile.Framework.Storage.Interfaces;

/// <summary>
/// Base interface for Azure Queue messages with a default queue name.
/// </summary>
/// <remarks>
/// <para>
/// Implementing types must provide a static <see cref="DefaultQueueName"/> property that returns
/// the queue name for this message type. This enables type-safe queue client retrieval
/// via <c>GetQueueClient&lt;T&gt;()</c> extension methods.
/// </para>
/// <para>
/// Queue names must be lowercase and can contain only letters, numbers, and hyphens.
/// The recommended convention is kebab-case (e.g., "tenant-verification").
/// </para>
/// </remarks>
/// <example>
/// <code>
/// public class TenantVerificationMessage : IQueueMessage
/// {
///     public static string DefaultQueueName => "tenant-verification";
///
///     public int TenantId { get; set; }
///     public DateTime RequestedAt { get; set; }
/// }
///
/// // Usage with type-safe extension method
/// var queue = queueServiceClient.GetQueueClient&lt;TenantVerificationMessage&gt;();
/// await queue.SendMessageAsync(JsonSerializer.Serialize(message));
/// </code>
/// </example>
public interface IQueueMessage
{
    /// <summary>
    /// Gets the default queue name for this message type.
    /// </summary>
    /// <value>
    /// The Azure Queue Storage queue name. Must be lowercase, 3-63 characters,
    /// and contain only letters, numbers, and hyphens.
    /// </value>
    static abstract string DefaultQueueName { get; }
}
```

2. Create `src/Imagile.Framework.Storage/Interfaces/IBlobContainer.cs`:
```csharp
namespace Imagile.Framework.Storage.Interfaces;

/// <summary>
/// Base interface for Azure Blob containers with a default container name.
/// </summary>
/// <remarks>
/// <para>
/// Implementing types must provide a static <see cref="DefaultContainerName"/> property that returns
/// the container name for this blob container type. This enables type-safe container client retrieval
/// via <c>GetBlobContainerClient&lt;T&gt;()</c> extension methods.
/// </para>
/// <para>
/// Container names must be lowercase and can contain only letters, numbers, and hyphens.
/// The recommended convention is kebab-case (e.g., "tenant-documents").
/// </para>
/// </remarks>
/// <example>
/// <code>
/// public class TenantDocumentContainer : IBlobContainer
/// {
///     public static string DefaultContainerName => "tenant-documents";
/// }
///
/// // Usage with type-safe extension method
/// var container = blobServiceClient.GetBlobContainerClient&lt;TenantDocumentContainer&gt;();
/// var blob = container.GetBlobClient($"tenants/{tenantId}/document.pdf");
/// await blob.UploadAsync(stream);
/// </code>
/// </example>
public interface IBlobContainer
{
    /// <summary>
    /// Gets the default container name for this container type.
    /// </summary>
    /// <value>
    /// The Azure Blob Storage container name. Must be lowercase, 3-63 characters,
    /// and contain only letters, numbers, and hyphens.
    /// </value>
    static abstract string DefaultContainerName { get; }
}
```
  </action>
  <verify>
`dotnet build src/Imagile.Framework.Storage` succeeds.
Both interface files exist with static abstract properties.
  </verify>
  <done>
IQueueMessage has static abstract DefaultQueueName property.
IBlobContainer has static abstract DefaultContainerName property.
Both interfaces have comprehensive XML documentation with examples.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create StorageAccountAttribute for multi-account support</name>
  <files>
    src/Imagile.Framework.Storage/Attributes/StorageAccountAttribute.cs
  </files>
  <action>
Create attribute for associating queue/container types with named storage accounts:

1. Create `src/Imagile.Framework.Storage/Attributes/StorageAccountAttribute.cs`:
```csharp
namespace Imagile.Framework.Storage.Attributes;

/// <summary>
/// Specifies which storage account a queue message or blob container type should use.
/// </summary>
/// <remarks>
/// <para>
/// Use this attribute to associate queue message or blob container types with specific
/// storage accounts when your application uses multiple Azure Storage accounts.
/// </para>
/// <para>
/// The <see cref="Name"/> property corresponds to the name used during DI registration
/// with <c>AddStorageAbstractions()</c>. Types without this attribute use the default
/// (unnamed) storage account.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// // Primary storage account (default)
/// public class UserNotificationMessage : IQueueMessage
/// {
///     public static string DefaultQueueName => "user-notifications";
///     public int UserId { get; set; }
/// }
///
/// // Archive storage account (named)
/// [StorageAccount("archive")]
/// public class AuditLogContainer : IBlobContainer
/// {
///     public static string DefaultContainerName => "audit-logs";
/// }
///
/// // DI registration
/// services.AddStorageAbstractions(config =>
/// {
///     config.AddStorageAccount(connectionString); // Default account
///     config.AddStorageAccount("archive", archiveConnectionString); // Named account
///     config.ScanAssemblies(typeof(UserNotificationMessage).Assembly);
/// });
/// </code>
/// </example>
[AttributeUsage(AttributeTargets.Class, AllowMultiple = false, Inherited = false)]
public sealed class StorageAccountAttribute : Attribute
{
    /// <summary>
    /// Gets the storage account name.
    /// </summary>
    /// <value>
    /// The name used during DI registration to identify this storage account.
    /// </value>
    public string Name { get; }

    /// <summary>
    /// Initializes a new instance of the <see cref="StorageAccountAttribute"/> class.
    /// </summary>
    /// <param name="name">
    /// The storage account name used during DI registration.
    /// This name must match the name used in <c>AddStorageAccount("name", ...)</c>.
    /// </param>
    /// <exception cref="ArgumentException">
    /// Thrown when <paramref name="name"/> is null, empty, or whitespace.
    /// </exception>
    public StorageAccountAttribute(string name)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(name);
        Name = name;
    }
}
```

2. Verify build:
```bash
dotnet build src/Imagile.Framework.Storage
```
  </action>
  <verify>
`dotnet build src/Imagile.Framework.Storage` succeeds with 0 errors, 0 warnings.
StorageAccountAttribute exists with Name property and constructor validation.
  </verify>
  <done>
StorageAccountAttribute allows decorating IQueueMessage/IBlobContainer implementations with storage account names.
Attribute has ArgumentException validation for null/empty/whitespace names.
XML documentation includes usage examples.
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. Solution builds: `dotnet build Imagile.Framework.sln` succeeds
2. Package dependencies correct: Azure.Storage.Queues, Azure.Storage.Blobs, Microsoft.Extensions.Azure referenced
3. Interfaces use C# 11 static abstract: Both interfaces compile without LangVersion errors
4. Attribute validates input: Constructor throws on null/empty name
</verification>

<success_criteria>
- [ ] Imagile.Framework.Storage package exists in solution
- [ ] IQueueMessage interface has `static abstract string DefaultQueueName { get; }`
- [ ] IBlobContainer interface has `static abstract string DefaultContainerName { get; }`
- [ ] StorageAccountAttribute accepts and stores account name
- [ ] All files have comprehensive XML documentation
- [ ] Solution builds with 0 errors, 0 warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-azure-storage-abstractions/06-01-SUMMARY.md`
</output>
