---
phase: 06-azure-storage-abstractions
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - tests/Imagile.Framework.Storage.Tests/Imagile.Framework.Storage.Tests.csproj
  - tests/Imagile.Framework.Storage.Tests/Interfaces/IQueueMessageTests.cs
  - tests/Imagile.Framework.Storage.Tests/Interfaces/IBlobContainerTests.cs
  - tests/Imagile.Framework.Storage.Tests/Attributes/StorageAccountAttributeTests.cs
  - tests/Imagile.Framework.Storage.Tests/Extensions/StorageClientExtensionsTests.cs
  - tests/Imagile.Framework.Storage.Tests/Initialization/StorageResourceScannerTests.cs
  - Imagile.Framework.sln
autonomous: true

must_haves:
  truths:
    - "Tests verify IQueueMessage implementations compile with static abstract property"
    - "Tests verify IBlobContainer implementations compile with static abstract property"
    - "Tests verify StorageAccountAttribute validates null/empty names"
    - "Tests verify StorageResourceScanner discovers interface implementations"
    - "Tests verify GetQueueClient<T>() and GetBlobContainerClient<T>() return correct clients"
  artifacts:
    - path: "tests/Imagile.Framework.Storage.Tests/Imagile.Framework.Storage.Tests.csproj"
      provides: "Test project with xUnit and FluentAssertions"
      contains: "PackageReference Include=\"xunit\""
    - path: "tests/Imagile.Framework.Storage.Tests/Initialization/StorageResourceScannerTests.cs"
      provides: "Scanner tests for type discovery"
      contains: "ScanForResources"
    - path: "tests/Imagile.Framework.Storage.Tests/Extensions/StorageClientExtensionsTests.cs"
      provides: "Extension method tests"
      contains: "GetQueueClient"
  key_links:
    - from: "Tests project"
      to: "Imagile.Framework.Storage"
      via: "ProjectReference"
      pattern: "ProjectReference.*Imagile\\.Framework\\.Storage"
---

<objective>
Create comprehensive unit tests for the Storage package interfaces, attributes, extensions, and scanner.

Purpose: Ensure all Storage abstractions work correctly through unit tests. Tests verify static abstract interface pattern, attribute validation, extension methods, and reflection-based scanning.

Output: Test project with full coverage of Storage package functionality.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-azure-storage-abstractions/06-CONTEXT.md
@.planning/phases/06-azure-storage-abstractions/06-RESEARCH.md
@.planning/phases/06-azure-storage-abstractions/06-01-SUMMARY.md
@.planning/phases/06-azure-storage-abstractions/06-02-SUMMARY.md
@src/Imagile.Framework.Storage/Interfaces/IQueueMessage.cs
@src/Imagile.Framework.Storage/Interfaces/IBlobContainer.cs
@src/Imagile.Framework.Storage/Attributes/StorageAccountAttribute.cs
@src/Imagile.Framework.Storage/Extensions/StorageClientExtensions.cs
@src/Imagile.Framework.Storage/Initialization/StorageResourceScanner.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test project with test fixtures</name>
  <files>
    tests/Imagile.Framework.Storage.Tests/Imagile.Framework.Storage.Tests.csproj
    tests/Imagile.Framework.Storage.Tests/TestFixtures/TestQueueMessage.cs
    tests/Imagile.Framework.Storage.Tests/TestFixtures/TestBlobContainer.cs
    Imagile.Framework.sln
  </files>
  <action>
Create the test project and test fixtures:

1. Create `tests/Imagile.Framework.Storage.Tests/Imagile.Framework.Storage.Tests.csproj`:
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" />
    <PackageReference Include="xunit" />
    <PackageReference Include="xunit.runner.visualstudio">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="FluentAssertions" />
    <PackageReference Include="NSubstitute" />
    <PackageReference Include="coverlet.collector">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\src\Imagile.Framework.Storage\Imagile.Framework.Storage.csproj" />
  </ItemGroup>

</Project>
```

2. Create `tests/Imagile.Framework.Storage.Tests/TestFixtures/TestQueueMessage.cs`:
```csharp
using Imagile.Framework.Storage.Attributes;
using Imagile.Framework.Storage.Interfaces;

namespace Imagile.Framework.Storage.Tests.TestFixtures;

/// <summary>
/// Test queue message for default storage account.
/// </summary>
public class TestQueueMessage : IQueueMessage
{
    public static string DefaultQueueName => "test-queue";

    public int TestId { get; set; }
    public string? TestData { get; set; }
}

/// <summary>
/// Test queue message for named storage account.
/// </summary>
[StorageAccount("archive")]
public class ArchiveQueueMessage : IQueueMessage
{
    public static string DefaultQueueName => "archive-queue";

    public DateTime ArchivedAt { get; set; }
}

/// <summary>
/// Another test queue message for scanning tests.
/// </summary>
public class AnotherQueueMessage : IQueueMessage
{
    public static string DefaultQueueName => "another-queue";
}
```

3. Create `tests/Imagile.Framework.Storage.Tests/TestFixtures/TestBlobContainer.cs`:
```csharp
using Imagile.Framework.Storage.Attributes;
using Imagile.Framework.Storage.Interfaces;

namespace Imagile.Framework.Storage.Tests.TestFixtures;

/// <summary>
/// Test blob container for default storage account.
/// </summary>
public class TestBlobContainer : IBlobContainer
{
    public static string DefaultContainerName => "test-container";
}

/// <summary>
/// Test blob container for named storage account.
/// </summary>
[StorageAccount("archive")]
public class ArchiveBlobContainer : IBlobContainer
{
    public static string DefaultContainerName => "archive-container";
}

/// <summary>
/// Another test blob container for scanning tests.
/// </summary>
public class AnotherBlobContainer : IBlobContainer
{
    public static string DefaultContainerName => "another-container";
}
```

4. Add project to solution:
```bash
dotnet sln Imagile.Framework.sln add tests/Imagile.Framework.Storage.Tests/Imagile.Framework.Storage.Tests.csproj
```

5. Build to verify:
```bash
dotnet build tests/Imagile.Framework.Storage.Tests
```
  </action>
  <verify>
`dotnet build tests/Imagile.Framework.Storage.Tests` succeeds.
Test fixtures implement IQueueMessage and IBlobContainer correctly.
  </verify>
  <done>
Test project exists with xUnit, FluentAssertions, NSubstitute.
Test fixtures demonstrate static abstract interface pattern.
Some fixtures have StorageAccountAttribute for multi-account testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create interface and attribute tests</name>
  <files>
    tests/Imagile.Framework.Storage.Tests/Interfaces/IQueueMessageTests.cs
    tests/Imagile.Framework.Storage.Tests/Interfaces/IBlobContainerTests.cs
    tests/Imagile.Framework.Storage.Tests/Attributes/StorageAccountAttributeTests.cs
  </files>
  <action>
Create tests for interfaces and StorageAccountAttribute:

1. Create `tests/Imagile.Framework.Storage.Tests/Interfaces/IQueueMessageTests.cs`:
```csharp
using FluentAssertions;
using Imagile.Framework.Storage.Interfaces;
using Imagile.Framework.Storage.Tests.TestFixtures;
using Xunit;

namespace Imagile.Framework.Storage.Tests.Interfaces;

[Trait("Category", "Unit")]
public class IQueueMessageTests
{
    [Fact]
    public void DefaultQueueName_ReturnsExpectedValue()
    {
        // Act
        var queueName = TestQueueMessage.DefaultQueueName;

        // Assert
        queueName.Should().Be("test-queue");
    }

    [Fact]
    public void DefaultQueueName_AccessibleViaGenericConstraint()
    {
        // Act
        var queueName = GetQueueName<TestQueueMessage>();

        // Assert
        queueName.Should().Be("test-queue");
    }

    [Fact]
    public void ImplementingType_CanBeInstantiated()
    {
        // Act
        var message = new TestQueueMessage
        {
            TestId = 123,
            TestData = "test"
        };

        // Assert
        message.TestId.Should().Be(123);
        message.TestData.Should().Be("test");
    }

    [Fact]
    public void MultipleImplementations_HaveDistinctQueueNames()
    {
        // Act
        var testQueueName = TestQueueMessage.DefaultQueueName;
        var archiveQueueName = ArchiveQueueMessage.DefaultQueueName;
        var anotherQueueName = AnotherQueueMessage.DefaultQueueName;

        // Assert
        testQueueName.Should().NotBe(archiveQueueName);
        testQueueName.Should().NotBe(anotherQueueName);
        archiveQueueName.Should().NotBe(anotherQueueName);
    }

    private static string GetQueueName<T>() where T : IQueueMessage
    {
        return T.DefaultQueueName;
    }
}
```

2. Create `tests/Imagile.Framework.Storage.Tests/Interfaces/IBlobContainerTests.cs`:
```csharp
using FluentAssertions;
using Imagile.Framework.Storage.Interfaces;
using Imagile.Framework.Storage.Tests.TestFixtures;
using Xunit;

namespace Imagile.Framework.Storage.Tests.Interfaces;

[Trait("Category", "Unit")]
public class IBlobContainerTests
{
    [Fact]
    public void DefaultContainerName_ReturnsExpectedValue()
    {
        // Act
        var containerName = TestBlobContainer.DefaultContainerName;

        // Assert
        containerName.Should().Be("test-container");
    }

    [Fact]
    public void DefaultContainerName_AccessibleViaGenericConstraint()
    {
        // Act
        var containerName = GetContainerName<TestBlobContainer>();

        // Assert
        containerName.Should().Be("test-container");
    }

    [Fact]
    public void MultipleImplementations_HaveDistinctContainerNames()
    {
        // Act
        var testContainerName = TestBlobContainer.DefaultContainerName;
        var archiveContainerName = ArchiveBlobContainer.DefaultContainerName;
        var anotherContainerName = AnotherBlobContainer.DefaultContainerName;

        // Assert
        testContainerName.Should().NotBe(archiveContainerName);
        testContainerName.Should().NotBe(anotherContainerName);
        archiveContainerName.Should().NotBe(anotherContainerName);
    }

    private static string GetContainerName<T>() where T : IBlobContainer
    {
        return T.DefaultContainerName;
    }
}
```

3. Create `tests/Imagile.Framework.Storage.Tests/Attributes/StorageAccountAttributeTests.cs`:
```csharp
using FluentAssertions;
using Imagile.Framework.Storage.Attributes;
using Xunit;

namespace Imagile.Framework.Storage.Tests.Attributes;

[Trait("Category", "Unit")]
public class StorageAccountAttributeTests
{
    [Fact]
    public void Constructor_WithValidName_SetsNameProperty()
    {
        // Act
        var attribute = new StorageAccountAttribute("archive");

        // Assert
        attribute.Name.Should().Be("archive");
    }

    [Fact]
    public void Constructor_WithNull_ThrowsArgumentException()
    {
        // Act
        var act = () => new StorageAccountAttribute(null!);

        // Assert
        act.Should().Throw<ArgumentException>();
    }

    [Fact]
    public void Constructor_WithEmptyString_ThrowsArgumentException()
    {
        // Act
        var act = () => new StorageAccountAttribute("");

        // Assert
        act.Should().Throw<ArgumentException>();
    }

    [Fact]
    public void Constructor_WithWhitespace_ThrowsArgumentException()
    {
        // Act
        var act = () => new StorageAccountAttribute("   ");

        // Assert
        act.Should().Throw<ArgumentException>();
    }

    [Fact]
    public void Attribute_CanBeAppliedToClass()
    {
        // Arrange
        var type = typeof(TestFixtures.ArchiveQueueMessage);

        // Act
        var attribute = type.GetCustomAttributes(typeof(StorageAccountAttribute), false)
            .FirstOrDefault() as StorageAccountAttribute;

        // Assert
        attribute.Should().NotBeNull();
        attribute!.Name.Should().Be("archive");
    }

    [Fact]
    public void Attribute_NotPresentOnUnmarkedClass()
    {
        // Arrange
        var type = typeof(TestFixtures.TestQueueMessage);

        // Act
        var attribute = type.GetCustomAttributes(typeof(StorageAccountAttribute), false)
            .FirstOrDefault() as StorageAccountAttribute;

        // Assert
        attribute.Should().BeNull();
    }
}
```

4. Run tests:
```bash
dotnet test tests/Imagile.Framework.Storage.Tests --filter "Category=Unit"
```
  </action>
  <verify>
All interface and attribute tests pass.
`dotnet test tests/Imagile.Framework.Storage.Tests --filter "Category=Unit"` shows green results.
  </verify>
  <done>
IQueueMessage tests verify static abstract property pattern works.
IBlobContainer tests verify static abstract property pattern works.
StorageAccountAttribute tests verify constructor validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create extension and scanner tests</name>
  <files>
    tests/Imagile.Framework.Storage.Tests/Extensions/StorageClientExtensionsTests.cs
    tests/Imagile.Framework.Storage.Tests/Initialization/StorageResourceScannerTests.cs
  </files>
  <action>
Create tests for extension methods and scanner:

1. Create `tests/Imagile.Framework.Storage.Tests/Extensions/StorageClientExtensionsTests.cs`:
```csharp
using Azure.Storage.Blobs;
using Azure.Storage.Queues;
using FluentAssertions;
using Imagile.Framework.Storage.Extensions;
using Imagile.Framework.Storage.Tests.TestFixtures;
using NSubstitute;
using Xunit;

namespace Imagile.Framework.Storage.Tests.Extensions;

[Trait("Category", "Unit")]
public class StorageClientExtensionsTests
{
    [Fact]
    public void GetQueueClient_WithNullClient_ThrowsArgumentNullException()
    {
        // Arrange
        QueueServiceClient client = null!;

        // Act
        var act = () => client.GetQueueClient<TestQueueMessage>();

        // Assert
        act.Should().Throw<ArgumentNullException>()
            .Which.ParamName.Should().Be("client");
    }

    [Fact]
    public void GetQueueClient_UsesDefaultQueueName()
    {
        // Arrange
        var client = Substitute.For<QueueServiceClient>();
        var expectedQueueClient = Substitute.For<QueueClient>();
        client.GetQueueClient("test-queue").Returns(expectedQueueClient);

        // Act
        var result = client.GetQueueClient<TestQueueMessage>();

        // Assert
        result.Should().BeSameAs(expectedQueueClient);
        client.Received(1).GetQueueClient("test-queue");
    }

    [Fact]
    public void GetBlobContainerClient_WithNullClient_ThrowsArgumentNullException()
    {
        // Arrange
        BlobServiceClient client = null!;

        // Act
        var act = () => client.GetBlobContainerClient<TestBlobContainer>();

        // Assert
        act.Should().Throw<ArgumentNullException>()
            .Which.ParamName.Should().Be("client");
    }

    [Fact]
    public void GetBlobContainerClient_UsesDefaultContainerName()
    {
        // Arrange
        var client = Substitute.For<BlobServiceClient>();
        var expectedContainerClient = Substitute.For<BlobContainerClient>();
        client.GetBlobContainerClient("test-container").Returns(expectedContainerClient);

        // Act
        var result = client.GetBlobContainerClient<TestBlobContainer>();

        // Assert
        result.Should().BeSameAs(expectedContainerClient);
        client.Received(1).GetBlobContainerClient("test-container");
    }
}
```

2. Create `tests/Imagile.Framework.Storage.Tests/Initialization/StorageResourceScannerTests.cs`:
```csharp
using System.Reflection;
using FluentAssertions;
using Imagile.Framework.Storage.Initialization;
using Imagile.Framework.Storage.Tests.TestFixtures;
using Xunit;

namespace Imagile.Framework.Storage.Tests.Initialization;

[Trait("Category", "Unit")]
public class StorageResourceScannerTests
{
    [Fact]
    public void ScanForResources_DiscoversQueueMessageTypes()
    {
        // Act
        var resources = StorageResourceScanner.ScanForResources(typeof(TestQueueMessage).Assembly);

        // Assert
        resources.QueueTypes.Should().Contain(typeof(TestQueueMessage));
        resources.QueueTypes.Should().Contain(typeof(ArchiveQueueMessage));
        resources.QueueTypes.Should().Contain(typeof(AnotherQueueMessage));
    }

    [Fact]
    public void ScanForResources_DiscoversBlobContainerTypes()
    {
        // Act
        var resources = StorageResourceScanner.ScanForResources(typeof(TestBlobContainer).Assembly);

        // Assert
        resources.ContainerTypes.Should().Contain(typeof(TestBlobContainer));
        resources.ContainerTypes.Should().Contain(typeof(ArchiveBlobContainer));
        resources.ContainerTypes.Should().Contain(typeof(AnotherBlobContainer));
    }

    [Fact]
    public void ScanForResources_ExcludesAbstractTypes()
    {
        // Act
        var resources = StorageResourceScanner.ScanForResources(typeof(TestQueueMessage).Assembly);

        // Assert
        resources.QueueTypes.Should().NotContain(t => t.IsAbstract);
        resources.ContainerTypes.Should().NotContain(t => t.IsAbstract);
    }

    [Fact]
    public void ScanForResources_WithNoAssemblies_UsesCallingAssembly()
    {
        // Act
        var resources = StorageResourceScanner.ScanForResources();

        // Assert - should scan this test assembly
        resources.Should().NotBeNull();
    }

    [Fact]
    public void ScanForResources_HasResources_ReturnsTrueWhenTypesFound()
    {
        // Act
        var resources = StorageResourceScanner.ScanForResources(typeof(TestQueueMessage).Assembly);

        // Assert
        resources.HasResources.Should().BeTrue();
        resources.TotalCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public void GetQueueName_ReturnsCorrectName()
    {
        // Act
        var queueName = StorageResourceScanner.GetQueueName(typeof(TestQueueMessage));

        // Assert
        queueName.Should().Be("test-queue");
    }

    [Fact]
    public void GetQueueName_WithNullType_ThrowsArgumentNullException()
    {
        // Act
        var act = () => StorageResourceScanner.GetQueueName(null!);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    [Fact]
    public void GetQueueName_WithInvalidType_ThrowsInvalidOperationException()
    {
        // Arrange - string doesn't have DefaultQueueName
        var invalidType = typeof(string);

        // Act
        var act = () => StorageResourceScanner.GetQueueName(invalidType);

        // Assert
        act.Should().Throw<InvalidOperationException>()
            .Which.Message.Should().Contain("DefaultQueueName");
    }

    [Fact]
    public void GetContainerName_ReturnsCorrectName()
    {
        // Act
        var containerName = StorageResourceScanner.GetContainerName(typeof(TestBlobContainer));

        // Assert
        containerName.Should().Be("test-container");
    }

    [Fact]
    public void GetContainerName_WithNullType_ThrowsArgumentNullException()
    {
        // Act
        var act = () => StorageResourceScanner.GetContainerName(null!);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    [Fact]
    public void GetContainerName_WithInvalidType_ThrowsInvalidOperationException()
    {
        // Arrange - string doesn't have DefaultContainerName
        var invalidType = typeof(string);

        // Act
        var act = () => StorageResourceScanner.GetContainerName(invalidType);

        // Assert
        act.Should().Throw<InvalidOperationException>()
            .Which.Message.Should().Contain("DefaultContainerName");
    }

    [Fact]
    public void GetStorageAccountName_ReturnsNameForAttributedType()
    {
        // Act
        var accountName = StorageResourceScanner.GetStorageAccountName(typeof(ArchiveQueueMessage));

        // Assert
        accountName.Should().Be("archive");
    }

    [Fact]
    public void GetStorageAccountName_ReturnsNullForUnattributedType()
    {
        // Act
        var accountName = StorageResourceScanner.GetStorageAccountName(typeof(TestQueueMessage));

        // Assert
        accountName.Should().BeNull();
    }

    [Fact]
    public void GetStorageAccountName_WithNullType_ThrowsArgumentNullException()
    {
        // Act
        var act = () => StorageResourceScanner.GetStorageAccountName(null!);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    [Fact]
    public void StorageResources_Empty_HasNoResources()
    {
        // Act
        var empty = StorageResources.Empty;

        // Assert
        empty.QueueTypes.Should().BeEmpty();
        empty.ContainerTypes.Should().BeEmpty();
        empty.HasResources.Should().BeFalse();
        empty.TotalCount.Should().Be(0);
    }
}
```

3. Run all tests:
```bash
dotnet test tests/Imagile.Framework.Storage.Tests
```

4. Verify solution builds:
```bash
dotnet build Imagile.Framework.sln
```
  </action>
  <verify>
All tests pass: `dotnet test tests/Imagile.Framework.Storage.Tests` shows all green.
Extension tests verify type-safe client retrieval.
Scanner tests verify assembly scanning and name extraction.
  </verify>
  <done>
StorageClientExtensions tests verify GetQueueClient<T>() and GetBlobContainerClient<T>().
StorageResourceScanner tests verify ScanForResources(), GetQueueName(), GetContainerName(), GetStorageAccountName().
All tests pass with correct behavior verification.
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. All tests pass: `dotnet test` shows 0 failures
2. Test coverage includes interfaces, attribute, extensions, scanner
3. Both positive and negative test cases present
4. Solution builds cleanly: `dotnet build Imagile.Framework.sln` succeeds
</verification>

<success_criteria>
- [ ] Test project exists with xUnit, FluentAssertions, NSubstitute
- [ ] Test fixtures implement IQueueMessage and IBlobContainer
- [ ] Interface tests verify static abstract pattern
- [ ] StorageAccountAttribute tests verify constructor validation
- [ ] Extension tests verify type-safe client retrieval
- [ ] Scanner tests verify assembly scanning and name extraction
- [ ] All tests pass: `dotnet test` shows 0 failures
- [ ] Solution builds with 0 errors, 0 warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-azure-storage-abstractions/06-04-SUMMARY.md`
</output>
