---
phase: 04-blazor-package
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsightsInitConfig.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor
  - src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsErrorBoundary.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/Telemetry/ITelemetryInitializerFactory.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/Telemetry/TelemetryInitializerFactory.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js
  - src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
autonomous: true

must_haves:
  truths:
    - "Developer can call AddBlazorApplicationInsights() and get IApplicationInsights registered in DI"
    - "Developer can add ApplicationInsightsInit component to App.razor and get automatic SDK initialization"
    - "Developer can track page views on initial load and on NavigationManager.LocationChanged events"
    - "Developer can configure connection string via Action<Config> callback or IConfiguration binding"
    - "Developer can wrap components in ApplicationInsightsErrorBoundary for automatic exception tracking"
    - "Developer can inject ITelemetryInitializerFactory to add context (tenant ID, user info) to all telemetry"
  artifacts:
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs"
      provides: "IApplicationInsights implementation with JS interop"
      contains: "class ApplicationInsights : IApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs"
      provides: "DI registration extension method"
      contains: "AddBlazorApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor"
      provides: "SDK initialization component"
      contains: "@inject IApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsErrorBoundary.cs"
      provides: "Automatic exception tracking via error boundary"
      contains: "class ApplicationInsightsErrorBoundary : ErrorBoundary"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/Telemetry/ITelemetryInitializerFactory.cs"
      provides: "Factory interface for context injection"
      contains: "interface ITelemetryInitializerFactory"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js"
      provides: "JS interop module for extended functionality"
      contains: "blazorApplicationInsights"
  key_links:
    - from: "ApplicationInsights.cs"
      to: "IJSRuntime"
      via: "InvokeVoidAsync"
      pattern: "_jsRuntime.InvokeVoidAsync"
    - from: "IServiceCollectionExtensions.cs"
      to: "ApplicationInsights.cs"
      via: "TryAddSingleton"
      pattern: "TryAddSingleton<IApplicationInsights, ApplicationInsights>"
    - from: "ApplicationInsightsInit.razor.cs"
      to: "NavigationManager"
      via: "LocationChanged subscription"
      pattern: "NavigationManager.LocationChanged"
    - from: "ApplicationInsightsErrorBoundary"
      to: "IApplicationInsights.TrackException"
      via: "OnErrorAsync override"
      pattern: "TrackException"
---

<objective>
Migrate the ApplicationInsights implementation, DI registration, initialization component, and add automatic exception tracking and telemetry initializer factory to enable WASM telemetry.

Purpose: Provide the core functionality that enables Blazor WASM apps to send telemetry to Application Insights. This covers BLAZOR-01 (page tracking), BLAZOR-02 (config), BLAZOR-03 (DI), BLAZOR-05 (exception tracking), and BLAZOR-08 (factory pattern).

Output: Working AddBlazorApplicationInsights() extension method, ApplicationInsightsInit component with navigation tracking, error boundary for automatic exceptions, and ITelemetryInitializerFactory for context injection.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-blazor-package/04-RESEARCH.md
@.planning/phases/04-blazor-package/04-01-SUMMARY.md

Source repository for migration:
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\ApplicationInsights.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\ApplicationInsightsInitConfig.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\IServiceCollectionExtensions.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\Components\ApplicationInsightsInit.razor.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\wwwroot\BlazorApplicationInsights.lib.module.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Implementation, Config, and DI Registration</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsightsInitConfig.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs
  </files>
  <action>
    Copy implementation files from source repository to framework package.

    ApplicationInsights.cs:
    1. Change namespace from `Imagile.BlazorApplicationInsights` to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update using statements for interfaces and models to new namespaces
    3. Preserve all XML documentation comments (inherit from interface)
    4. Keep all IJSRuntime.InvokeVoidAsync/InvokeAsync calls unchanged (JS SDK method names)

    ApplicationInsightsInitConfig.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update model references to new namespace
    3. This class holds Config and OnAppInsightsInit callback for DI

    IServiceCollectionExtensions.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update all internal type references to new namespaces
    3. Remove JetBrains.Annotations [PublicAPI] attribute
    4. Keep PretendBrowserPlatform internal property for unit testing
    5. Preserve DummyOptionsMonitor inner class implementation
    6. Add overload that accepts IConfiguration for appsettings.json binding:
       ```csharp
       public static IServiceCollection AddBlazorApplicationInsights(
           this IServiceCollection services,
           IConfiguration configuration,
           string sectionName = "ApplicationInsights",
           Func<IApplicationInsights, Task>? onAppInsightsInit = null,
           bool addWasmLogger = true)
       {
           var config = new Config();
           configuration.GetSection(sectionName).Bind(config);
           return services.AddBlazorApplicationInsights(c => {
               // Copy bound values to config
               c.ConnectionString = config.ConnectionString;
               c.EnableAutoRouteTracking = config.EnableAutoRouteTracking;
               // ... other properties
           }, onAppInsightsInit, addWasmLogger);
       }
       ```

    Key implementation details to preserve:
    - _jsRuntime field for JS interop
    - InitJSRuntime() method for runtime injection
    - All tracking methods delegate to JS SDK via appInsights.* or blazorApplicationInsights.*
  </action>
  <verify>
    File exists: `type src\Imagile.Framework.Blazor.ApplicationInsights\ApplicationInsights.cs`
    Should contain "class ApplicationInsights : IApplicationInsights"
  </verify>
  <done>ApplicationInsights implementation, config, and DI registration migrated with IConfiguration overload</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Init Component with NavigationManager Tracking</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor
    src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor.cs
  </files>
  <action>
    Migrate Razor component from source repository with enhanced navigation tracking.

    ApplicationInsightsInit.razor:
    1. Create Components/ folder
    2. Create minimal Razor file that renders the script markup
    3. The component should use @inherits ComponentBase and call code-behind

    ApplicationInsightsInit.razor.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights.Components`
    2. Update _content path from "Imagile.BlazorApplicationInsights" to "Imagile.Framework.Blazor.ApplicationInsights"
    3. Preserve the JavaScript SDK snippet generation in OnInitialized()
    4. Preserve OnAfterRenderAsync logic for JS module import and initial page view
    5. **ADD NavigationManager subscription for ongoing page tracking (BLAZOR-01):**
       ```csharp
       [Inject] private NavigationManager NavigationManager { get; set; }

       protected override void OnInitialized()
       {
           base.OnInitialized();
           NavigationManager.LocationChanged += OnLocationChanged;
       }

       private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
       {
           try
           {
               await ApplicationInsights.TrackPageView(new PageViewTelemetry
               {
                   Name = e.Location,
                   Uri = e.Location
               });
           }
           catch (Exception ex)
           {
               Logger.LogWarning(ex, "Failed to track page view for {Location}", e.Location);
           }
       }

       public void Dispose()
       {
           NavigationManager.LocationChanged -= OnLocationChanged;
       }
       ```
    6. Implement IDisposable to unsubscribe from LocationChanged

    Critical: Update the JS module import path:
    FROM: "./_content/Imagile.BlazorApplicationInsights/BlazorApplicationInsights.lib.module.js"
    TO: "./_content/Imagile.Framework.Blazor.ApplicationInsights/BlazorApplicationInsights.lib.module.js"
  </action>
  <verify>
    Check files exist:
    `if (Test-Path "src\Imagile.Framework.Blazor.ApplicationInsights\Components\ApplicationInsightsInit.razor.cs") { "EXISTS" } else { "MISSING" }`
    Build: `dotnet build src/Imagile.Framework.Blazor.ApplicationInsights -c Release`
  </verify>
  <done>Init component migrated with NavigationManager.LocationChanged subscription for automatic page tracking</done>
</task>

<task type="auto">
  <name>Task 3: Add Error Boundary, Telemetry Factory, JS Module, and Update Project</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsErrorBoundary.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/Telemetry/ITelemetryInitializerFactory.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/Telemetry/TelemetryInitializerFactory.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js
    src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
  </files>
  <action>
    **Create ApplicationInsightsErrorBoundary for automatic exception tracking (BLAZOR-05):**

    ```csharp
    namespace Imagile.Framework.Blazor.ApplicationInsights.Components;

    /// <summary>
    /// Error boundary that automatically tracks unhandled exceptions to Application Insights.
    /// Wrap your app content or specific components to enable automatic exception tracking.
    /// </summary>
    public class ApplicationInsightsErrorBoundary : ErrorBoundary
    {
        [Inject] private IApplicationInsights ApplicationInsights { get; set; } = default!;
        [Inject] private ILogger<ApplicationInsightsErrorBoundary> Logger { get; set; } = default!;

        protected override async Task OnErrorAsync(Exception exception)
        {
            try
            {
                await ApplicationInsights.TrackException(new ExceptionTelemetry
                {
                    Exception = new Error
                    {
                        Name = exception.GetType().FullName ?? exception.GetType().Name,
                        Message = exception.Message,
                        Stack = exception.StackTrace
                    },
                    SeverityLevel = SeverityLevel.Error
                });
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Failed to track exception to Application Insights");
            }

            await base.OnErrorAsync(exception);
        }
    }
    ```

    **Create ITelemetryInitializerFactory for context injection (BLAZOR-08):**

    Create Telemetry/ folder and add:

    ```csharp
    // ITelemetryInitializerFactory.cs
    namespace Imagile.Framework.Blazor.ApplicationInsights.Telemetry;

    /// <summary>
    /// Factory interface for creating telemetry initializers with DI-injected context.
    /// Implement this to add tenant ID, user info, or other context to all telemetry.
    /// </summary>
    public interface ITelemetryInitializerFactory
    {
        /// <summary>
        /// Creates a TelemetryItem that will be merged into all outgoing telemetry.
        /// Called once during SDK initialization.
        /// </summary>
        Task<TelemetryItem> CreateInitializerAsync();
    }
    ```

    ```csharp
    // TelemetryInitializerFactory.cs - Default implementation
    namespace Imagile.Framework.Blazor.ApplicationInsights.Telemetry;

    /// <summary>
    /// Default telemetry initializer factory that adds no additional context.
    /// Override by registering your own ITelemetryInitializerFactory in DI.
    /// </summary>
    public class DefaultTelemetryInitializerFactory : ITelemetryInitializerFactory
    {
        public Task<TelemetryItem> CreateInitializerAsync()
        {
            return Task.FromResult(new TelemetryItem());
        }
    }
    ```

    Update IServiceCollectionExtensions to register ITelemetryInitializerFactory:
    ```csharp
    services.TryAddSingleton<ITelemetryInitializerFactory, DefaultTelemetryInitializerFactory>();
    ```

    Update ApplicationInsightsInit.razor.cs to use factory in OnAfterRenderAsync:
    ```csharp
    [Inject] private ITelemetryInitializerFactory TelemetryInitializerFactory { get; set; }

    // In OnAfterRenderAsync after SDK init:
    var initializer = await TelemetryInitializerFactory.CreateInitializerAsync();
    await ApplicationInsights.AddTelemetryInitializer(initializer);
    ```

    **Migrate JS module:**
    1. Create wwwroot/ folder
    2. Copy JS module from source repository (no changes needed - pure JavaScript)
    3. This module provides: addTelemetryInitializer, trackDependencyData, getContext, cookieMgr* methods

    **Update project file:**
    1. Add required package references:
       - Microsoft.AspNetCore.Components.Web (for ComponentBase, IJSRuntime, ErrorBoundary)
       - Microsoft.Extensions.Logging (for ILoggerProvider)
       - Microsoft.Extensions.Configuration.Binder (for IConfiguration.Bind)
    2. Add InternalsVisibleTo for future test project
    3. Configure static web assets fingerprinting

    Verify full build succeeds and static assets are included.
  </action>
  <verify>
    Full solution build: `dotnet build Imagile.Framework.sln -c Release`
    JS module bundled: `if (Test-Path "src\Imagile.Framework.Blazor.ApplicationInsights\bin\Release\net10.0\staticwebassets\*") { Get-ChildItem "src\Imagile.Framework.Blazor.ApplicationInsights\bin\Release\net10.0\staticwebassets" } else { "Check obj folder"; Get-ChildItem "src\Imagile.Framework.Blazor.ApplicationInsights\obj\Release\net10.0\staticwebassets.build.json" -ErrorAction SilentlyContinue }`
  </verify>
  <done>Error boundary for automatic exceptions, telemetry initializer factory for context injection, JS module migrated, full solution builds</done>
</task>

</tasks>

<verification>
- `dotnet build Imagile.Framework.sln -c Release` succeeds
- ApplicationInsights class implements all IApplicationInsights methods
- IServiceCollectionExtensions.AddBlazorApplicationInsights() compiles with both overloads
- ApplicationInsightsInit component:
  - Generates JavaScript SDK snippet
  - Subscribes to NavigationManager.LocationChanged
  - Uses ITelemetryInitializerFactory for context injection
- ApplicationInsightsErrorBoundary tracks exceptions via TrackException
- ITelemetryInitializerFactory registered in DI for custom context injection
- JS module included in static web assets
- No breaking changes to public API from source package
</verification>

<success_criteria>
- AddBlazorApplicationInsights() extension method available (Action<Config> and IConfiguration overloads)
- ApplicationInsightsInit component:
  - Ready for use in App.razor
  - Tracks initial page view
  - Tracks navigation via LocationChanged (BLAZOR-01)
- ApplicationInsightsErrorBoundary:
  - Can wrap components for automatic exception tracking (BLAZOR-05)
  - Calls TrackException on unhandled errors
- ITelemetryInitializerFactory:
  - Provides factory pattern for context injection (BLAZOR-08)
  - Developer can implement custom factory for tenant ID, user info, etc.
- All tracking methods (TrackEvent, TrackPageView, TrackException, etc.) implemented
- JS interop working with correct _content path
- Solution builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-blazor-package/04-02-SUMMARY.md`
</output>
