---
phase: 04-blazor-package
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsightsInitConfig.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor
  - src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor.cs
  - src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js
  - src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
autonomous: true

must_haves:
  truths:
    - "AddBlazorApplicationInsights() registers IApplicationInsights in DI container"
    - "ApplicationInsightsInit component injects JS SDK snippet into page"
    - "TrackPageView() sends page view telemetry via JS interop"
    - "Connection string configurable via Config callback in AddBlazorApplicationInsights()"
  artifacts:
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs"
      provides: "IApplicationInsights implementation with JS interop"
      contains: "class ApplicationInsights : IApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs"
      provides: "DI registration extension method"
      contains: "AddBlazorApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor"
      provides: "SDK initialization component"
      contains: "@inject IApplicationInsights"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js"
      provides: "JS interop module for extended functionality"
      contains: "blazorApplicationInsights"
  key_links:
    - from: "ApplicationInsights.cs"
      to: "IJSRuntime"
      via: "InvokeVoidAsync"
      pattern: "_jsRuntime.InvokeVoidAsync"
    - from: "IServiceCollectionExtensions.cs"
      to: "ApplicationInsights.cs"
      via: "TryAddSingleton"
      pattern: "TryAddSingleton<IApplicationInsights, ApplicationInsights>"
    - from: "ApplicationInsightsInit.razor.cs"
      to: "ApplicationInsights.cs"
      via: "InitJSRuntime call"
      pattern: "ApplicationInsights.InitJSRuntime"
---

<objective>
Migrate the ApplicationInsights implementation, DI registration, and initialization component to enable WASM telemetry.

Purpose: Provide the core functionality that enables Blazor WASM apps to send telemetry to Application Insights. This is the primary user-facing API.

Output: Working AddBlazorApplicationInsights() extension method, ApplicationInsightsInit component, and complete JS interop implementation.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-blazor-package/04-RESEARCH.md
@.planning/phases/04-blazor-package/04-01-SUMMARY.md

Source repository for migration:
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\ApplicationInsights.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\ApplicationInsightsInitConfig.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\IServiceCollectionExtensions.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\Components\ApplicationInsightsInit.razor.cs
@C:\Code\Imagile.BlazorApplicationInsights\src\Imagile.BlazorApplicationInsights\wwwroot\BlazorApplicationInsights.lib.module.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Implementation and Config Classes</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsights.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/ApplicationInsightsInitConfig.cs
  </files>
  <action>
    Copy implementation files from source repository to framework package.

    ApplicationInsights.cs:
    1. Change namespace from `Imagile.BlazorApplicationInsights` to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update using statements for interfaces and models to new namespaces
    3. Preserve all XML documentation comments (inherit from interface)
    4. Keep all IJSRuntime.InvokeVoidAsync/InvokeAsync calls unchanged (JS SDK method names)

    ApplicationInsightsInitConfig.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update model references to new namespace
    3. This class holds Config and OnAppInsightsInit callback for DI

    Key implementation details to preserve:
    - _jsRuntime field for JS interop
    - InitJSRuntime() method for runtime injection
    - All tracking methods delegate to JS SDK via appInsights.* or blazorApplicationInsights.*
  </action>
  <verify>
    File exists: `type src\Imagile.Framework.Blazor.ApplicationInsights\ApplicationInsights.cs`
    Should contain "class ApplicationInsights : IApplicationInsights"
  </verify>
  <done>ApplicationInsights implementation and config classes migrated with correct namespaces</done>
</task>

<task type="auto">
  <name>Task 2: Migrate DI Registration and Initialization Component</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/IServiceCollectionExtensions.cs
    src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor
    src/Imagile.Framework.Blazor.ApplicationInsights/Components/ApplicationInsightsInit.razor.cs
  </files>
  <action>
    Migrate DI registration and Razor component from source repository.

    IServiceCollectionExtensions.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update all internal type references to new namespaces
    3. Remove JetBrains.Annotations [PublicAPI] attribute
    4. Keep PretendBrowserPlatform internal property for unit testing
    5. Preserve DummyOptionsMonitor inner class implementation

    ApplicationInsightsInit.razor:
    1. Create Components/ folder
    2. Create minimal Razor file that renders the script markup
    3. The component should use @inherits ComponentBase and call code-behind

    ApplicationInsightsInit.razor.cs:
    1. Change namespace to `Imagile.Framework.Blazor.ApplicationInsights`
    2. Update _content path from "Imagile.BlazorApplicationInsights" to "Imagile.Framework.Blazor.ApplicationInsights"
    3. Preserve the JavaScript SDK snippet generation in OnInitialized()
    4. Preserve OnAfterRenderAsync logic for JS module import and initial page view

    Critical: Update the JS module import path:
    FROM: "./_content/Imagile.BlazorApplicationInsights/BlazorApplicationInsights.lib.module.js"
    TO: "./_content/Imagile.Framework.Blazor.ApplicationInsights/BlazorApplicationInsights.lib.module.js"
  </action>
  <verify>
    Check files exist in Components folder
    Build: `dotnet build src/Imagile.Framework.Blazor.ApplicationInsights -c Release`
  </verify>
  <done>DI registration and initialization component migrated, build succeeds</done>
</task>

<task type="auto">
  <name>Task 3: Migrate JS Module and Update Project File</name>
  <files>
    src/Imagile.Framework.Blazor.ApplicationInsights/wwwroot/BlazorApplicationInsights.lib.module.js
    src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
  </files>
  <action>
    Migrate JavaScript module and update project file for Razor library.

    wwwroot/BlazorApplicationInsights.lib.module.js:
    1. Create wwwroot/ folder
    2. Copy JS module from source repository (no changes needed - pure JavaScript)
    3. This module provides: addTelemetryInitializer, trackDependencyData, getContext, cookieMgr* methods

    Update Imagile.Framework.Blazor.ApplicationInsights.csproj:
    1. Add required package references that may be missing:
       - Microsoft.AspNetCore.Components.Web (for ComponentBase, IJSRuntime)
       - Microsoft.Extensions.Logging (for ILoggerProvider)
    2. Add InternalsVisibleTo for future test project:
       <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleToAttribute">
         <_Parameter1>Imagile.Framework.Blazor.ApplicationInsights.Tests</_Parameter1>
       </AssemblyAttribute>
    3. Ensure StaticWebAssetFingerprintingEnabled is configured:
       <StaticWebAssetFingerprintingEnabled>false</StaticWebAssetFingerprintingEnabled>
       <StaticWebAssetsFingerprintContent>false</StaticWebAssetsFingerprintContent>

    Verify full build succeeds and static assets are included.
  </action>
  <verify>
    Full solution build: `dotnet build Imagile.Framework.sln -c Release`
    JS module bundled: Check bin/Release/net10.0/staticwebassets folder or .staticwebassets.endpoints.json
  </verify>
  <done>JS module migrated, project file updated, full solution builds successfully</done>
</task>

</tasks>

<verification>
- `dotnet build Imagile.Framework.sln -c Release` succeeds
- ApplicationInsights class implements all IApplicationInsights methods
- IServiceCollectionExtensions.AddBlazorApplicationInsights() compiles
- ApplicationInsightsInit component generates JavaScript SDK snippet
- JS module included in static web assets
- No breaking changes to public API from source package
</verification>

<success_criteria>
- AddBlazorApplicationInsights() extension method available
- ApplicationInsightsInit component ready for use in App.razor
- All tracking methods (TrackEvent, TrackPageView, TrackException, etc.) implemented
- JS interop working with correct _content path
- Solution builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-blazor-package/04-02-SUMMARY.md`
</output>
