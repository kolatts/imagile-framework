---
phase: 04-blazor-package
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockJSRuntime.cs
  - Imagile.Framework.sln
  - Directory.Packages.props
autonomous: true

must_haves:
  truths:
    - "Unit tests verify ApplicationInsights class methods call correct JS functions"
    - "Unit tests verify ILoggerProvider creates loggers correctly"
    - "Mock JSRuntime enables testing without browser environment"
    - "All tests pass: dotnet test succeeds"
  artifacts:
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj"
      provides: "Test project configuration"
      contains: "Imagile.Framework.Blazor.ApplicationInsights.Tests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs"
      provides: "Core telemetry tests"
      contains: "class ApplicationInsightsTests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs"
      provides: "Logger integration tests"
      contains: "class LoggingTests"
  key_links:
    - from: "Test project"
      to: "Main package"
      via: "ProjectReference"
      pattern: "ProjectReference.*Imagile.Framework.Blazor.ApplicationInsights.csproj"
---

<objective>
Create unit tests for the Blazor Application Insights package to verify JS interop calls and logging integration.

Purpose: Ensure the migrated code functions correctly before release. Tests validate that telemetry methods call the expected JS functions and logging integration works.

Output: Complete test suite with passing tests, test project integrated into solution.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-blazor-package/04-RESEARCH.md
@.planning/phases/04-blazor-package/04-02-SUMMARY.md
@.planning/phases/04-blazor-package/04-03-SUMMARY.md

Reference test patterns from source repository:
@C:\Code\Imagile.BlazorApplicationInsights\tests\BlazorApplicationInsights.Tests\UnitTests.cs
@C:\Code\Imagile.BlazorApplicationInsights\tests\BlazorApplicationInsights.Tests\Logging\ApplicationInsightsLoggerTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test Project and Mock Infrastructure</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockJSRuntime.cs
    Imagile.Framework.sln
    Directory.Packages.props
  </files>
  <action>
    Create test project for Blazor Application Insights package.

    1. Create test project file with:
       - Target: net10.0
       - IsPackable: false
       - IsTestProject: true
       - References to xunit, FluentAssertions, Microsoft.NET.Test.Sdk
       - ProjectReference to main package

    2. Create MockJSRuntime class:
       - Implements IJSRuntime
       - Records all InvokeAsync/InvokeVoidAsync calls with method names and arguments
       - Returns default values or configurable responses
       - Pattern from source: tracks (identifier, args) tuples for verification

    3. Update Directory.Packages.props if needed:
       - Add Moq or NSubstitute if not present (optional - can use manual mocks)
       - Existing packages should suffice: xunit, FluentAssertions

    4. Add test project to Imagile.Framework.sln:
       `dotnet sln Imagile.Framework.sln add tests/Imagile.Framework.Blazor.ApplicationInsights.Tests`
  </action>
  <verify>
    Solution build: `dotnet build Imagile.Framework.sln -c Release`
    Test project listed: `dotnet sln Imagile.Framework.sln list`
  </verify>
  <done>Test project created, mock infrastructure in place, solution updated</done>
</task>

<task type="auto">
  <name>Task 2: Create ApplicationInsights Tests</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs
  </files>
  <action>
    Create unit tests for ApplicationInsights class.

    Test cases to implement:
    1. TrackEvent_CallsCorrectJSMethod
       - Create ApplicationInsights, init with mock JS runtime
       - Call TrackEvent with EventTelemetry
       - Verify mock received "appInsights.trackEvent" call

    2. TrackPageView_CallsCorrectJSMethod
       - Call TrackPageView with PageViewTelemetry
       - Verify mock received "appInsights.trackPageView" call

    3. TrackException_CallsCorrectJSMethod
       - Call TrackException with ExceptionTelemetry
       - Verify mock received "appInsights.trackException" call

    4. TrackTrace_CallsCorrectJSMethod
       - Call TrackTrace with TraceTelemetry
       - Verify mock received "appInsights.trackTrace" call

    5. AddTelemetryInitializer_CallsBlazorJSMethod
       - Call AddTelemetryInitializer
       - Verify mock received "blazorApplicationInsights.addTelemetryInitializer" call

    6. Flush_CallsCorrectJSMethod
       - Call Flush()
       - Verify mock received "appInsights.flush" call

    Test pattern:
    ```csharp
    [Fact]
    public async Task TrackEvent_CallsCorrectJSMethod()
    {
        var mockJs = new MockJSRuntime();
        var appInsights = new ApplicationInsights();
        appInsights.InitJSRuntime(mockJs);

        await appInsights.TrackEvent(new EventTelemetry { Name = "TestEvent" });

        mockJs.Invocations.Should().ContainSingle()
            .Which.Identifier.Should().Be("appInsights.trackEvent");
    }
    ```
  </action>
  <verify>
    Run tests: `dotnet test tests/Imagile.Framework.Blazor.ApplicationInsights.Tests`
    All tests should pass
  </verify>
  <done>ApplicationInsights unit tests created and passing</done>
</task>

<task type="auto">
  <name>Task 3: Create Logging Tests and Final Verification</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs
  </files>
  <action>
    Create unit tests for logging integration.

    Test cases to implement:
    1. LoggerProvider_CreatesLogger
       - Create ApplicationInsightsLoggerProvider with mock IApplicationInsights
       - Call CreateLogger("TestCategory")
       - Verify logger is returned and not null

    2. Logger_LogInformation_CallsTrackTrace
       - Get logger from provider
       - Call LogInformation("Test message")
       - Verify mock IApplicationInsights.TrackTrace was called

    3. Logger_BelowMinLevel_DoesNotTrack
       - Configure options with MinimumLogLevel = Warning
       - Call LogInformation (below threshold)
       - Verify TrackTrace was NOT called

    4. Logger_AtMinLevel_TracksMessage
       - Configure options with MinimumLogLevel = Warning
       - Call LogWarning
       - Verify TrackTrace WAS called

    5. Logger_IncludesCategory_InProperties
       - Create logger with specific category
       - Log a message
       - Verify TraceTelemetry contains category in properties

    For logging tests, mock IApplicationInsights directly (not JSRuntime) since logger doesn't use JS directly.

    Run full test suite to verify everything works:
    `dotnet test Imagile.Framework.sln`
  </action>
  <verify>
    All tests pass: `dotnet test Imagile.Framework.sln --verbosity normal`
    Test count: Should have at least 10 tests total
  </verify>
  <done>Logging tests created, all tests passing, package verified complete</done>
</task>

</tasks>

<verification>
- Test project compiles and is part of solution
- MockJSRuntime enables testing without browser
- ApplicationInsights tests verify JS method calls
- Logging tests verify ILoggerProvider integration
- All tests pass: `dotnet test Imagile.Framework.sln`
- No test failures or warnings
</verification>

<success_criteria>
- Test project: tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/
- At least 10 unit tests covering core functionality
- All tests pass
- Test coverage includes: TrackEvent, TrackPageView, TrackException, TrackTrace, logging
- Solution builds and tests cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-blazor-package/04-04-SUMMARY.md`
</output>
