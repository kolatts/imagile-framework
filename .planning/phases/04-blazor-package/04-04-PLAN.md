---
phase: 04-blazor-package
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ErrorBoundaryTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/TelemetryInitializerFactoryTests.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockJSRuntime.cs
  - tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockApplicationInsights.cs
  - Imagile.Framework.sln
  - Directory.Packages.props
autonomous: true

must_haves:
  truths:
    - "Unit tests verify ApplicationInsights class methods call correct JS functions"
    - "Unit tests verify ILoggerProvider creates loggers correctly"
    - "Unit tests verify ApplicationInsightsErrorBoundary tracks exceptions automatically"
    - "Unit tests verify ITelemetryInitializerFactory creates initializers for context injection"
    - "Mock JSRuntime enables testing without browser environment"
    - "All tests pass: dotnet test succeeds"
  artifacts:
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj"
      provides: "Test project configuration"
      contains: "Imagile.Framework.Blazor.ApplicationInsights.Tests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs"
      provides: "Core telemetry tests"
      contains: "class ApplicationInsightsTests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs"
      provides: "Logger integration tests"
      contains: "class LoggingTests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ErrorBoundaryTests.cs"
      provides: "Error boundary tests for automatic exception tracking"
      contains: "class ErrorBoundaryTests"
    - path: "tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/TelemetryInitializerFactoryTests.cs"
      provides: "Telemetry initializer factory tests"
      contains: "class TelemetryInitializerFactoryTests"
  key_links:
    - from: "Test project"
      to: "Main package"
      via: "ProjectReference"
      pattern: "ProjectReference.*Imagile.Framework.Blazor.ApplicationInsights.csproj"
---

<objective>
Create unit tests for the Blazor Application Insights package to verify JS interop calls, logging integration, error boundary, and telemetry initializer factory.

Purpose: Ensure the migrated code functions correctly before release. Tests validate that telemetry methods call the expected JS functions, logging integration works, automatic exception tracking via error boundary functions, and telemetry initializer factory creates context correctly.

Output: Complete test suite with passing tests, test project integrated into solution.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-blazor-package/04-RESEARCH.md
@.planning/phases/04-blazor-package/04-02-SUMMARY.md
@.planning/phases/04-blazor-package/04-03-SUMMARY.md

Reference test patterns from source repository:
@C:\Code\Imagile.BlazorApplicationInsights\tests\BlazorApplicationInsights.Tests\UnitTests.cs
@C:\Code\Imagile.BlazorApplicationInsights\tests\BlazorApplicationInsights.Tests\Logging\ApplicationInsightsLoggerTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test Project and Mock Infrastructure</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Imagile.Framework.Blazor.ApplicationInsights.Tests.csproj
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockJSRuntime.cs
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/Mocks/MockApplicationInsights.cs
    Imagile.Framework.sln
    Directory.Packages.props
  </files>
  <action>
    Create test project for Blazor Application Insights package.

    1. Create test project file with:
       - Target: net10.0
       - IsPackable: false
       - IsTestProject: true
       - References to xunit, FluentAssertions, Microsoft.NET.Test.Sdk
       - ProjectReference to main package

    2. Create MockJSRuntime class:
       - Implements IJSRuntime
       - Records all InvokeAsync/InvokeVoidAsync calls with method names and arguments
       - Returns default values or configurable responses
       - Pattern from source: tracks (identifier, args) tuples for verification

    3. Create MockApplicationInsights class:
       - Implements IApplicationInsights
       - Records all method calls (TrackEvent, TrackException, TrackTrace, etc.)
       - Enables verification of what telemetry was sent
       - Used for testing components that inject IApplicationInsights (like ErrorBoundary)

    4. Update Directory.Packages.props if needed:
       - Add Moq or NSubstitute if not present (optional - can use manual mocks)
       - Existing packages should suffice: xunit, FluentAssertions

    5. Add test project to Imagile.Framework.sln:
       `dotnet sln Imagile.Framework.sln add tests/Imagile.Framework.Blazor.ApplicationInsights.Tests`
  </action>
  <verify>
    Solution build: `dotnet build Imagile.Framework.sln -c Release`
    Test project listed: `dotnet sln Imagile.Framework.sln list`
  </verify>
  <done>Test project created, mock infrastructure in place, solution updated</done>
</task>

<task type="auto">
  <name>Task 2: Create ApplicationInsights and Logging Tests</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ApplicationInsightsTests.cs
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/LoggingTests.cs
  </files>
  <action>
    Create unit tests for ApplicationInsights class and logging integration.

    **ApplicationInsightsTests.cs** - Test cases to implement:
    1. TrackEvent_CallsCorrectJSMethod
       - Create ApplicationInsights, init with mock JS runtime
       - Call TrackEvent with EventTelemetry
       - Verify mock received "appInsights.trackEvent" call

    2. TrackPageView_CallsCorrectJSMethod
       - Call TrackPageView with PageViewTelemetry
       - Verify mock received "appInsights.trackPageView" call

    3. TrackException_CallsCorrectJSMethod
       - Call TrackException with ExceptionTelemetry
       - Verify mock received "appInsights.trackException" call

    4. TrackTrace_CallsCorrectJSMethod
       - Call TrackTrace with TraceTelemetry
       - Verify mock received "appInsights.trackTrace" call

    5. AddTelemetryInitializer_CallsBlazorJSMethod
       - Call AddTelemetryInitializer
       - Verify mock received "blazorApplicationInsights.addTelemetryInitializer" call

    6. Flush_CallsCorrectJSMethod
       - Call Flush()
       - Verify mock received "appInsights.flush" call

    **LoggingTests.cs** - Test cases to implement:
    1. LoggerProvider_CreatesLogger
       - Create ApplicationInsightsLoggerProvider with mock IApplicationInsights
       - Call CreateLogger("TestCategory")
       - Verify logger is returned and not null

    2. Logger_LogInformation_CallsTrackTrace
       - Get logger from provider
       - Call LogInformation("Test message")
       - Verify mock IApplicationInsights.TrackTrace was called

    3. Logger_BelowMinLevel_DoesNotTrack
       - Configure options with MinimumLogLevel = Warning
       - Call LogInformation (below threshold)
       - Verify TrackTrace was NOT called

    4. Logger_AtMinLevel_TracksMessage
       - Configure options with MinimumLogLevel = Warning
       - Call LogWarning
       - Verify TrackTrace WAS called

    5. Logger_IncludesCategory_InProperties
       - Create logger with specific category
       - Log a message
       - Verify TraceTelemetry contains category in properties
  </action>
  <verify>
    Run tests: `dotnet test tests/Imagile.Framework.Blazor.ApplicationInsights.Tests --filter "FullyQualifiedName~ApplicationInsightsTests|FullyQualifiedName~LoggingTests"`
    All tests should pass
  </verify>
  <done>ApplicationInsights and logging unit tests created and passing</done>
</task>

<task type="auto">
  <name>Task 3: Create ErrorBoundary and TelemetryInitializerFactory Tests</name>
  <files>
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/ErrorBoundaryTests.cs
    tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/TelemetryInitializerFactoryTests.cs
  </files>
  <action>
    Create unit tests for new components added for BLAZOR-05 and BLAZOR-08.

    **ErrorBoundaryTests.cs** - Test cases for ApplicationInsightsErrorBoundary:
    1. OnErrorAsync_TracksExceptionToApplicationInsights
       - Create mock IApplicationInsights
       - Create ErrorBoundary with mock injected
       - Simulate error via OnErrorAsync(new Exception("Test"))
       - Verify mock received TrackException call with correct error details

    2. OnErrorAsync_IncludesExceptionType_InTelemetry
       - Throw ArgumentNullException
       - Verify ExceptionTelemetry.Exception.Name contains "ArgumentNullException"

    3. OnErrorAsync_IncludesStackTrace_WhenAvailable
       - Throw exception with stack trace
       - Verify ExceptionTelemetry.Exception.Stack is populated

    4. OnErrorAsync_SetsErrorSeverityLevel
       - Track any exception
       - Verify SeverityLevel is Error (not Warning or lower)

    5. OnErrorAsync_ContinuesToBaseHandler_AfterTracking
       - Verify base.OnErrorAsync is called after tracking

    **TelemetryInitializerFactoryTests.cs** - Test cases for ITelemetryInitializerFactory:
    1. DefaultFactory_ReturnsEmptyTelemetryItem
       - Create DefaultTelemetryInitializerFactory
       - Call CreateInitializerAsync()
       - Verify returns TelemetryItem with no custom data

    2. CustomFactory_CanAddTenantId
       - Create custom implementation that sets tags["ai.cloud.roleInstance"] = "tenant-123"
       - Verify TelemetryItem contains the tenant ID

    3. CustomFactory_CanAddUserContext
       - Create custom implementation that populates user context
       - Verify TelemetryItem contains user information

    4. Factory_IsRegisteredInDI_WhenAddBlazorApplicationInsightsCalled
       - Build service collection with AddBlazorApplicationInsights()
       - Resolve ITelemetryInitializerFactory
       - Verify it returns DefaultTelemetryInitializerFactory

    5. CustomFactory_OverridesDefault_WhenRegisteredFirst
       - Register custom factory BEFORE AddBlazorApplicationInsights
       - Resolve ITelemetryInitializerFactory
       - Verify custom factory is returned (TryAddSingleton respects existing)

    Run full test suite to verify everything works:
    `dotnet test Imagile.Framework.sln`
  </action>
  <verify>
    All tests pass: `dotnet test Imagile.Framework.sln --verbosity normal`
    Test count: Should have at least 15 tests total (6 AppInsights + 5 Logging + 5 ErrorBoundary + 5 Factory)
  </verify>
  <done>ErrorBoundary and TelemetryInitializerFactory tests created, all tests passing, package verified complete</done>
</task>

</tasks>

<verification>
- Test project compiles and is part of solution
- MockJSRuntime enables testing without browser
- MockApplicationInsights enables testing components that inject IApplicationInsights
- ApplicationInsights tests verify JS method calls
- Logging tests verify ILoggerProvider integration
- ErrorBoundary tests verify automatic exception tracking (BLAZOR-05)
- TelemetryInitializerFactory tests verify context injection pattern (BLAZOR-08)
- All tests pass: `dotnet test Imagile.Framework.sln`
- No test failures or warnings
</verification>

<success_criteria>
- Test project: tests/Imagile.Framework.Blazor.ApplicationInsights.Tests/
- At least 15 unit tests covering core functionality
- All tests pass
- Test coverage includes:
  - TrackEvent, TrackPageView, TrackException, TrackTrace
  - ILoggerProvider integration
  - ApplicationInsightsErrorBoundary automatic exception tracking
  - ITelemetryInitializerFactory context injection
- Solution builds and tests cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-blazor-package/04-04-SUMMARY.md`
</output>
