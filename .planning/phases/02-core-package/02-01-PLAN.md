---
phase: 02-core-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Imagile.Framework.Core/Imagile.Framework.Core.csproj
  - src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
  - src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
  - Directory.Packages.props
  - Imagile.Framework.sln
  - .github/workflows/publish-nuget.yml
autonomous: true

must_haves:
  truths:
    - "All framework projects exist in src/ folder following established pattern"
    - "Core project has zero PackageReference elements"
    - "EntityFrameworkCore project references Core and EF Core packages"
    - "Blazor.ApplicationInsights project references Core and Application Insights packages"
    - "All projects compile without warnings with AOT analysis enabled"
    - "GitHub Actions workflow exists for automated NuGet publishing"
  artifacts:
    - path: "src/Imagile.Framework.Core/Imagile.Framework.Core.csproj"
      provides: "Core package project file with zero dependencies"
      contains: "net10.0"
    - path: "src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj"
      provides: "EF Core package project file with Core dependency"
      contains: "net10.0"
    - path: "src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj"
      provides: "Blazor Application Insights package project file with Core dependency"
      contains: "net10.0"
    - path: ".github/workflows/publish-nuget.yml"
      provides: "GitHub Actions workflow for NuGet publishing"
      contains: "dotnet nuget push"
  key_links:
    - from: "src/Imagile.Framework.Core/Imagile.Framework.Core.csproj"
      to: "Directory.Build.props"
      via: "MSBuild inheritance"
      pattern: "inherits shared properties"
    - from: "src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj"
      to: "src/Imagile.Framework.Core/Imagile.Framework.Core.csproj"
      via: "ProjectReference"
      pattern: "depends on Core package"
    - from: "src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj"
      to: "src/Imagile.Framework.Core/Imagile.Framework.Core.csproj"
      via: "ProjectReference"
      pattern: "depends on Core package"
---

<objective>
Create all framework package project structures (Core, EntityFrameworkCore, Blazor.ApplicationInsights) and set up automated NuGet publishing.

Purpose: Establish the complete multi-package structure upfront to enable parallel development. Core package must have zero dependencies. EntityFrameworkCore and Blazor.ApplicationInsights packages will reference Core and their respective framework dependencies. GitHub Actions workflow enables continuous delivery to NuGet.org.
Output: All three buildable project files and publishing automation ready for implementation work across future phases.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-package/02-RESEARCH.md
@src/Imagile.Framework.EntityFrameworkCore.Testing/Imagile.Framework.EntityFrameworkCore.Testing.csproj
@Directory.Build.props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all framework project structures</name>
  <files>
    src/Imagile.Framework.Core/Imagile.Framework.Core.csproj
    src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
    src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
  </files>
  <action>
Create all three framework package directories and project files:

**1. Core Package (Zero Dependencies)**

1. Create folder: src/Imagile.Framework.Core/
2. Create folder: src/Imagile.Framework.Core/Attributes/

3. Create Imagile.Framework.Core.csproj with:
   - SDK: Microsoft.NET.Sdk
   - TargetFramework: net10.0
   - ImplicitUsings: enable
   - Nullable: enable
   - IsPackable: true
   - IsTestProject: false

   NuGet Package Metadata:
   - PackageId: Imagile.Framework.Core
   - RootNamespace: Imagile.Framework.Core
   - AssemblyName: Imagile.Framework.Core
   - Description: "Zero-dependency declarative attributes for building opinionated .NET applications. Contains association, metadata, and validation marker attributes."
   - PackageTags: attributes;validation;metadata;declarative;enum;framework
   - PackageReadmeFile: README.md

   ItemGroup for README:
   - None Include="..\..\README.md" Pack="true" PackagePath="\"

   CRITICAL: NO PackageReference elements. Zero-dependency package.

**2. EntityFrameworkCore Package**

1. Create folder: src/Imagile.Framework.EntityFrameworkCore/

2. Create Imagile.Framework.EntityFrameworkCore.csproj with:
   - SDK: Microsoft.NET.Sdk
   - TargetFramework: net10.0
   - ImplicitUsings: enable
   - Nullable: enable
   - IsPackable: true
   - IsTestProject: false

   NuGet Package Metadata:
   - PackageId: Imagile.Framework.EntityFrameworkCore
   - RootNamespace: Imagile.Framework.EntityFrameworkCore
   - AssemblyName: Imagile.Framework.EntityFrameworkCore
   - Description: "EF Core audit logging with automatic timestamps, user tracking, and property-level change tracking."
   - PackageTags: entityframeworkcore;efcore;audit;changetracking;softdelete;framework
   - PackageReadmeFile: README.md

   ItemGroup for README:
   - None Include="..\..\README.md" Pack="true" PackagePath="\"

   ItemGroup for Dependencies:
   - ProjectReference Include="..\Imagile.Framework.Core\Imagile.Framework.Core.csproj"
   - PackageReference Include="Microsoft.EntityFrameworkCore" (version managed by Directory.Packages.props)

**3. Blazor.ApplicationInsights Package**

1. Create folder: src/Imagile.Framework.Blazor.ApplicationInsights/

2. Create Imagile.Framework.Blazor.ApplicationInsights.csproj with:
   - SDK: Microsoft.NET.Sdk.Razor
   - TargetFramework: net10.0
   - ImplicitUsings: enable
   - Nullable: enable
   - IsPackable: true
   - IsTestProject: false

   NuGet Package Metadata:
   - PackageId: Imagile.Framework.Blazor.ApplicationInsights
   - RootNamespace: Imagile.Framework.Blazor.ApplicationInsights
   - AssemblyName: Imagile.Framework.Blazor.ApplicationInsights
   - Description: "Application Insights telemetry integration for Blazor WebAssembly with automatic page tracking and custom event support."
   - PackageTags: blazor;webassembly;applicationinsights;telemetry;monitoring;framework
   - PackageReadmeFile: README.md

   ItemGroup for README:
   - None Include="..\..\README.md" Pack="true" PackagePath="\"

   ItemGroup for Dependencies:
   - ProjectReference Include="..\Imagile.Framework.Core\Imagile.Framework.Core.csproj"
   - PackageReference Include="Microsoft.ApplicationInsights" (version managed by Directory.Packages.props)
   - PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly" (version managed by Directory.Packages.props)
  </action>
  <verify>
1. Run: dotnet build src/Imagile.Framework.Core/Imagile.Framework.Core.csproj
   - Must succeed
2. Verify Core has zero PackageReference: grep -c "PackageReference" src/Imagile.Framework.Core/Imagile.Framework.Core.csproj should return 0
3. Run: dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
   - Must succeed
4. Run: dotnet build src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj
   - Must succeed
5. Run: dotnet pack src/Imagile.Framework.Core -c Release
   - Must produce Imagile.Framework.Core.*.nupkg
  </verify>
  <done>All three framework project files exist with correct dependencies, compile successfully, and can produce NuGet packages.</done>
</task>

<task type="auto">
  <name>Task 2: Update Directory.Packages.props with framework package versions</name>
  <files>Directory.Packages.props</files>
  <action>
Add package versions for the new framework dependencies:

1. Add Microsoft.ApplicationInsights version entry:
   - Version: 2.22.0 (latest stable for .NET 10)

2. Add Microsoft.AspNetCore.Components.WebAssembly version entry:
   - Version: 10.0.0 (matches .NET 10)

These should be added to the ItemGroup in Directory.Packages.props, replacing the placeholder comments.
  </action>
  <verify>
1. Run: dotnet restore Imagile.Framework.sln
   - Must succeed without version conflicts
2. Verify versions are centrally managed: Check that Directory.Packages.props contains the new PackageVersion entries
  </verify>
  <done>Directory.Packages.props updated with Application Insights and Blazor package versions for centralized version management.</done>
</task>

<task type="auto">
  <name>Task 3: Add all framework projects to solution</name>
  <files>Imagile.Framework.sln</files>
  <action>
Add all three framework projects to the solution:

1. Run: dotnet sln Imagile.Framework.sln add src/Imagile.Framework.Core/Imagile.Framework.Core.csproj
2. Run: dotnet sln Imagile.Framework.sln add src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
3. Run: dotnet sln Imagile.Framework.sln add src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj

This integrates all framework projects into the solution build.
  </action>
  <verify>
1. Run: dotnet sln Imagile.Framework.sln list
   - Should show Core, EntityFrameworkCore, Blazor.ApplicationInsights, and EntityFrameworkCore.Testing
2. Run: dotnet build Imagile.Framework.sln
   - All projects must build successfully
  </verify>
  <done>All framework projects added to solution and build as part of solution-wide build.</done>
</task>

<task type="auto">
  <name>Task 4: Create GitHub Actions workflow for NuGet publishing</name>
  <files>.github/workflows/publish-nuget.yml</files>
  <action>
Create a GitHub Actions workflow to publish all packages to NuGet.org:

1. Create folder: .github/workflows/

2. Create publish-nuget.yml with:

```yaml
name: Publish to NuGet

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # GitVersion needs full history

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore Imagile.Framework.sln

    - name: Build solution
      run: dotnet build Imagile.Framework.sln --configuration Release --no-restore

    - name: Pack Core package
      run: dotnet pack src/Imagile.Framework.Core/Imagile.Framework.Core.csproj --configuration Release --no-build --output ./packages

    - name: Pack EntityFrameworkCore package
      run: dotnet pack src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --configuration Release --no-build --output ./packages

    - name: Pack Blazor.ApplicationInsights package
      run: dotnet pack src/Imagile.Framework.Blazor.ApplicationInsights/Imagile.Framework.Blazor.ApplicationInsights.csproj --configuration Release --no-build --output ./packages

    - name: Publish to NuGet.org
      run: dotnet nuget push ./packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
```

Workflow features:
- Triggers on version tags (v1.0.0, v2.1.3, etc.)
- Manual trigger via workflow_dispatch
- Builds all packages in Release mode
- Packs all three framework packages
- Publishes to NuGet.org using NUGET_API_KEY secret
- Skips duplicates (allows re-running without errors)

Note: User must add NUGET_API_KEY to GitHub repository secrets before first publish.
  </action>
  <verify>
1. Verify workflow file exists: ls .github/workflows/publish-nuget.yml
2. Validate YAML syntax: Check that file is valid YAML (GitHub Actions will validate on push)
3. Verify workflow includes all three packages: grep -c "dotnet pack src/Imagile.Framework" .github/workflows/publish-nuget.yml should return 3
  </verify>
  <done>GitHub Actions workflow created for automated NuGet package publishing on version tags.</done>
</task>

</tasks>

<verification>
1. Full solution builds: `dotnet build Imagile.Framework.sln` succeeds with all 4 projects
2. Core project has zero dependencies: No PackageReference elements in Core .csproj
3. EntityFrameworkCore project references Core: ProjectReference to Core exists
4. Blazor.ApplicationInsights project references Core: ProjectReference to Core exists
5. All packages can be created: `dotnet pack` produces .nupkg for all three framework packages
6. AOT analysis enabled: Build output shows no trim/AOT warnings (inherited from Directory.Build.props)
7. GitHub Actions workflow exists: .github/workflows/publish-nuget.yml file exists
8. Workflow includes all packages: Workflow contains dotnet pack commands for all three framework packages
</verification>

<success_criteria>
- All three framework projects exist in src/ (Core, EntityFrameworkCore, Blazor.ApplicationInsights)
- Core project file has zero PackageReference elements
- EntityFrameworkCore and Blazor.ApplicationInsights reference Core and their respective framework dependencies
- Solution builds successfully with all 4 projects (including EntityFrameworkCore.Testing)
- NuGet packages can be created for all three framework packages
- GitHub Actions workflow configured to publish all packages to NuGet.org on version tags
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-package/02-01-SUMMARY.md`
</output>
