---
phase: 05-configuration-abstractions
plan: 02
type: tdd
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/Imagile.Framework.Configuration/Extensions/ConfigurationExtensions.cs
  - tests/Imagile.Framework.Configuration.Tests/Imagile.Framework.Configuration.Tests.csproj
  - tests/Imagile.Framework.Configuration.Tests/Extensions/ConfigurationExtensionsTests.cs
  - Imagile.Framework.sln

autonomous: true

must_haves:
  truths:
    - "Configuration values matching @KeyVault(SecretName) are replaced with actual secret values"
    - "Replacement is recursive through all configuration sections"
    - "Missing secrets throw RequestFailedException immediately (fail-fast)"
    - "Non-matching configuration values are unchanged"
  artifacts:
    - path: "src/Imagile.Framework.Configuration/Extensions/ConfigurationExtensions.cs"
      provides: "ReplaceKeyVaultReferences extension method"
      contains: "@KeyVault("
    - path: "tests/Imagile.Framework.Configuration.Tests/Extensions/ConfigurationExtensionsTests.cs"
      provides: "Unit tests for Key Vault replacement"
      contains: "ReplaceKeyVaultReferences"
  key_links:
    - from: "ConfigurationExtensions.cs"
      to: "SecretClient"
      via: "method parameter"
      pattern: "SecretClient secretClient"
    - from: "ConfigurationExtensions.cs"
      to: "IConfiguration"
      via: "extension method"
      pattern: "this IConfiguration"
---

<objective>
Implement Key Vault reference replacement using TDD approach.

Purpose: The @KeyVault(SecretName) syntax allows configuration files to reference secrets without exposing values, with replacement happening at startup before options binding.

Output: ConfigurationExtensions.ReplaceKeyVaultReferences() method with comprehensive test coverage.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-abstractions/05-CONTEXT.md
@.planning/phases/05-configuration-abstractions/05-RESEARCH.md
@.planning/phases/05-configuration-abstractions/05-01-SUMMARY.md

# Source file to migrate
@C:\Code\imagile-app\Imagile.App.Backend\Extensions\ConfigurationManagerExtensions.cs
</context>

<feature>
  <name>Key Vault Reference Replacement</name>
  <files>
    src/Imagile.Framework.Configuration/Extensions/ConfigurationExtensions.cs
    tests/Imagile.Framework.Configuration.Tests/Extensions/ConfigurationExtensionsTests.cs
  </files>
  <behavior>
Expected behavior in testable terms:

1. Single value replacement:
   - Input: Configuration section with value "@KeyVault(DbConnectionString)"
   - SecretClient returns "Server=db;Password=secret"
   - Output: Configuration section value is "Server=db;Password=secret"

2. Nested value replacement:
   - Input: Configuration with Database:ConnectionString = "@KeyVault(DbSecret)"
   - SecretClient returns secret value
   - Output: Nested value replaced, other values unchanged

3. Multiple replacements:
   - Input: Configuration with multiple @KeyVault() references
   - Output: All references replaced in single call

4. Non-matching values unchanged:
   - Input: Configuration with "NormalValue" and "@KeyVault(Secret)"
   - Output: "NormalValue" unchanged, "@KeyVault(Secret)" replaced

5. Missing secret handling:
   - Input: @KeyVault(NonExistentSecret)
   - SecretClient throws RequestFailedException
   - Output: Exception propagates (fail-fast)

6. Null/empty configuration:
   - Input: Empty configuration or null secretClient
   - Output: ArgumentNullException thrown

7. Case sensitivity:
   - Input: "@KeyVault(Secret)" (exact case) works
   - Input: "@keyvault(Secret)" (lowercase) is NOT replaced (documented limitation)
  </behavior>
  <implementation>
Create test project tests/Imagile.Framework.Configuration.Tests:
- Reference Imagile.Framework.Configuration
- Reference xunit, FluentAssertions, Moq (or NSubstitute if used elsewhere)
- Add to solution

Create mock/fake SecretClient for testing:
- Option 1: Use Moq to mock SecretClient.GetSecret()
- Option 2: Create test helper that wraps Dictionary<string, string> as fake vault

Implement ConfigurationExtensions.cs:
1. Public extension method on IConfiguration
2. Takes SecretClient parameter
3. Validates inputs with ArgumentNullException.ThrowIfNull
4. Recursively traverses configuration using GetChildren()
5. Checks for @KeyVault(SecretName) pattern using StartsWith/EndsWith
6. Extracts secret name, calls secretClient.GetSecret()
7. Replaces section.Value in-place

Follow TDD cycle:
1. RED: Write failing tests first
2. GREEN: Implement minimal code to pass
3. REFACTOR: Clean up if needed
  </implementation>
</feature>

<verification>
1. All tests pass: `dotnet test tests/Imagile.Framework.Configuration.Tests`
2. Solution builds: `dotnet build Imagile.Framework.sln`
3. Code has XML documentation: Check ConfigurationExtensions.cs
</verification>

<success_criteria>
- Test project created and added to solution
- All test cases pass
- ReplaceKeyVaultReferences extension method works with:
  - Simple configuration values
  - Nested configuration sections
  - Multiple Key Vault references
- Fail-fast behavior on missing secrets
- Enhanced XML documentation with examples
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-abstractions/05-02-SUMMARY.md`
</output>
