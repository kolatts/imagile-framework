---
phase: 05-configuration-abstractions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Imagile.Framework.Configuration/Imagile.Framework.Configuration.csproj
  - src/Imagile.Framework.Configuration/Credentials/AppTokenCredential.cs
  - Imagile.Framework.sln
  - Directory.Packages.props

autonomous: true

must_haves:
  truths:
    - "Developer can reference Imagile.Framework.Configuration package from NuGet"
    - "AppTokenCredential works identically to imagile-app version"
    - "Cloud environments use WorkloadIdentity + ManagedIdentity credential chain"
    - "Local environments use AzureCli + VisualStudio credential chain"
  artifacts:
    - path: "src/Imagile.Framework.Configuration/Imagile.Framework.Configuration.csproj"
      provides: "Package configuration with Azure.Identity dependency"
      contains: "Azure.Identity"
    - path: "src/Imagile.Framework.Configuration/Credentials/AppTokenCredential.cs"
      provides: "Environment-aware TokenCredential implementation"
      contains: "ChainedTokenCredential"
  key_links:
    - from: "Imagile.Framework.Configuration.csproj"
      to: "Imagile.Framework.Core"
      via: "ProjectReference"
      pattern: "Imagile\\.Framework\\.Core"
    - from: "AppTokenCredential.cs"
      to: "Azure.Identity"
      via: "using directive"
      pattern: "using Azure\\.Identity"
---

<objective>
Create the Imagile.Framework.Configuration package scaffold and migrate AppTokenCredential from imagile-app.

Purpose: Establishes the new Configuration package with proper project structure and the foundational credential abstraction that all Azure SDK clients will use.

Output: New Imagile.Framework.Configuration project with AppTokenCredential class ready for use.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-abstractions/05-CONTEXT.md
@.planning/phases/05-configuration-abstractions/05-RESEARCH.md

# Source file to migrate
@C:\Code\imagile-app\Imagile.App.Backend\Configuration\AppTokenCredential.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Configuration package project</name>
  <files>
    src/Imagile.Framework.Configuration/Imagile.Framework.Configuration.csproj
    Imagile.Framework.sln
    Directory.Packages.props
  </files>
  <action>
Create new class library project src/Imagile.Framework.Configuration/Imagile.Framework.Configuration.csproj following the existing Core package pattern.

Project file must include:
- TargetFramework: net10.0
- ImplicitUsings: enable
- Nullable: enable
- IsPackable: true
- IsTestProject: false
- PackageId: Imagile.Framework.Configuration
- Description: Azure configuration patterns including environment-aware credentials, Key Vault integration, and startup validation.
- PackageTags: configuration;azure;keyvault;credentials;validation;framework
- PackageReadmeFile: README.md (reference main README like Core does)

Add ProjectReference to Imagile.Framework.Core (same pattern as EntityFrameworkCore project).

Add PackageReferences (use existing pattern - versions come from Directory.Packages.props):
- Azure.Identity
- Azure.Security.KeyVault.Secrets
- Microsoft.Extensions.Configuration
- Microsoft.Extensions.Options.DataAnnotations
- Microsoft.Extensions.DependencyInjection.Abstractions

Update Directory.Packages.props to add these package versions if not present:
- Azure.Identity: 1.17.1
- Azure.Security.KeyVault.Secrets: 4.8.0
- Microsoft.Extensions.Options.DataAnnotations: 10.0.1

Add project to Imagile.Framework.sln in src folder.
  </action>
  <verify>
    - `dotnet build src/Imagile.Framework.Configuration` compiles without errors
    - `dotnet build Imagile.Framework.sln` builds entire solution successfully
  </verify>
  <done>
    Configuration package exists in solution, references Core package, has all required dependencies, and compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate AppTokenCredential</name>
  <files>
    src/Imagile.Framework.Configuration/Credentials/AppTokenCredential.cs
  </files>
  <action>
Create src/Imagile.Framework.Configuration/Credentials/AppTokenCredential.cs by migrating from imagile-app source.

Migration changes:
1. Update namespace from Imagile.App.Backend.Configuration to Imagile.Framework.Configuration.Credentials
2. Keep all logic identical (proven production pattern)
3. Enhance XML documentation with detailed remarks section explaining:
   - Cloud credential chain: WorkloadIdentityCredential (for AKS) then ManagedIdentityCredential (for App Service/Container Apps)
   - Local credential chain: AzureCliCredential (fastest) then VisualStudioCredential
   - Why ChainedTokenCredential over DefaultAzureCredential (performance - only tries 2 credentials instead of 10+)
4. Add XML example showing typical usage with SecretClient
5. Keep class public and non-sealed (allows extension if needed)
6. Constructor takes optional managedIdentityClientId parameter - when null/empty uses local chain, when provided uses cloud chain

The class inherits from Azure.Core.TokenCredential and wraps a ChainedTokenCredential internally.
  </action>
  <verify>
    - `dotnet build src/Imagile.Framework.Configuration` compiles without errors or warnings
    - Grep confirms class contains ChainedTokenCredential, WorkloadIdentityCredential, ManagedIdentityCredential, AzureCliCredential, VisualStudioCredential
  </verify>
  <done>
    AppTokenCredential class exists with enhanced documentation, correct namespace, and identical functionality to imagile-app version.
  </done>
</task>

</tasks>

<verification>
1. Solution builds: `dotnet build Imagile.Framework.sln`
2. Package has correct dependencies: Inspect csproj for Azure.Identity, Azure.Security.KeyVault.Secrets
3. AppTokenCredential is in correct namespace: Imagile.Framework.Configuration.Credentials
4. Class inherits from TokenCredential: Check class declaration
</verification>

<success_criteria>
- Imagile.Framework.Configuration project exists and compiles
- Project references Imagile.Framework.Core
- AppTokenCredential migrated with enhanced documentation
- All Azure dependencies properly configured via Central Package Management
- Solution builds without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-abstractions/05-01-SUMMARY.md`
</output>
