---
phase: 05-configuration-abstractions
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/Imagile.Framework.Configuration/Extensions/ServiceCollectionExtensions.cs
  - src/Imagile.Framework.Configuration/FrameworkConfigurationBuilder.cs

autonomous: true

must_haves:
  truths:
    - "Developer can call services.AddFrameworkConfiguration() to configure the package"
    - "WithKeyVault() registers SecretClient and triggers Key Vault replacement"
    - "WithValidation() enables ValidateOnStart for all IOptions"
    - "Methods are chainable for fluent API pattern"
  artifacts:
    - path: "src/Imagile.Framework.Configuration/Extensions/ServiceCollectionExtensions.cs"
      provides: "AddFrameworkConfiguration extension method"
      contains: "AddFrameworkConfiguration"
    - path: "src/Imagile.Framework.Configuration/FrameworkConfigurationBuilder.cs"
      provides: "Fluent builder for configuration"
      contains: "WithKeyVault"
  key_links:
    - from: "ServiceCollectionExtensions.cs"
      to: "FrameworkConfigurationBuilder"
      via: "instantiation"
      pattern: "new FrameworkConfigurationBuilder"
    - from: "FrameworkConfigurationBuilder.cs"
      to: "ConfigurationExtensions"
      via: "method call"
      pattern: "ReplaceKeyVaultReferences"
---

<objective>
Create fluent API for DI registration with Key Vault and validation configuration.

Purpose: Provides clean, discoverable API for consuming applications to configure the framework's configuration features.

Output: AddFrameworkConfiguration() extension method with WithKeyVault() and WithValidation() builder methods.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-abstractions/05-CONTEXT.md
@.planning/phases/05-configuration-abstractions/05-RESEARCH.md
@.planning/phases/05-configuration-abstractions/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FrameworkConfigurationBuilder</name>
  <files>
    src/Imagile.Framework.Configuration/FrameworkConfigurationBuilder.cs
  </files>
  <action>
Create FrameworkConfigurationBuilder class that provides the fluent API for configuration.

Class design:
- Constructor takes IServiceCollection and IConfiguration parameters
- Stores both as private readonly fields
- Each With* method returns `this` for chaining

WithKeyVault(Uri vaultUri, TokenCredential credential) method:
1. Create SecretClient with provided vaultUri and credential
2. Call configuration.ReplaceKeyVaultReferences(secretClient) immediately
3. Register SecretClient as singleton in services
4. Return this for chaining

WithKeyVault(SecretClient secretClient) overload:
1. Call configuration.ReplaceKeyVaultReferences(secretClient)
2. Register provided SecretClient as singleton
3. Return this for chaining

WithValidation() method:
1. This is a marker - actual validation happens per-options with ValidateOnStart
2. Could add helper method or just document the pattern
3. Consider registering IStartupFilter that validates all IOptions at startup
4. Simplest: Just return this and document that consumers use ValidateDataAnnotations().ValidateOnStart() per options class

Note: WithValidation() may be minimal since ValidateOnStart is applied per-options class. Consider whether to:
- Option A: Just document the pattern (simplest)
- Option B: Create helper extension for AddOptions<T> that includes ValidateDataAnnotations().ValidateOnStart()

Use Option A for initial implementation - keep it simple.

XML documentation must include:
- Class summary explaining fluent builder pattern
- Method summaries with parameter descriptions
- Example usage in class-level documentation
  </action>
  <verify>
    - `dotnet build src/Imagile.Framework.Configuration` compiles without errors
    - Class has WithKeyVault and WithValidation methods
    - Methods return FrameworkConfigurationBuilder for chaining
  </verify>
  <done>
    FrameworkConfigurationBuilder exists with fluent API methods and comprehensive XML documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ServiceCollectionExtensions</name>
  <files>
    src/Imagile.Framework.Configuration/Extensions/ServiceCollectionExtensions.cs
  </files>
  <action>
Create ServiceCollectionExtensions class with AddFrameworkConfiguration extension method.

Method signature:
```csharp
public static IServiceCollection AddFrameworkConfiguration(
    this IServiceCollection services,
    IConfiguration configuration,
    Action<FrameworkConfigurationBuilder> configure)
```

Implementation:
1. Validate inputs with ArgumentNullException.ThrowIfNull
2. Create new FrameworkConfigurationBuilder(services, configuration)
3. Invoke configure(builder) action
4. Return services for chaining

XML documentation must include:
- Method summary explaining purpose
- Parameter descriptions
- Detailed example showing typical usage:
  ```csharp
  builder.Services.AddFrameworkConfiguration(
      builder.Configuration,
      config => config
          .WithKeyVault(
              new Uri(builder.Configuration["Azure:KeyVaultUri"]!),
              new AppTokenCredential())
          .WithValidation());
  ```
- Remarks section explaining call order (Key Vault replacement before options binding)
  </action>
  <verify>
    - `dotnet build src/Imagile.Framework.Configuration` compiles without errors
    - Extension method exists on IServiceCollection
    - XML documentation includes example code
  </verify>
  <done>
    AddFrameworkConfiguration extension method available on IServiceCollection with comprehensive documentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and solution build</name>
  <files>
    (no new files - verification only)
  </files>
  <action>
Verify the complete package works together:

1. Build entire solution: `dotnet build Imagile.Framework.sln`
2. Run all tests: `dotnet test`
3. Verify package can be packed: `dotnet pack src/Imagile.Framework.Configuration -c Release -o ./artifacts`
4. Check XML documentation generates without warnings

Ensure all public types have XML documentation:
- AppTokenCredential
- ConfigurationExtensions
- ServiceCollectionExtensions
- FrameworkConfigurationBuilder

Verify namespace consistency:
- Root namespace: Imagile.Framework.Configuration
- Credentials folder: Imagile.Framework.Configuration.Credentials
- Extensions folder: Imagile.Framework.Configuration.Extensions
  </action>
  <verify>
    - `dotnet build Imagile.Framework.sln` succeeds with no warnings
    - `dotnet test` passes all tests
    - `dotnet pack src/Imagile.Framework.Configuration -c Release` creates nupkg
  </verify>
  <done>
    Phase 5 complete. Imagile.Framework.Configuration package is ready with:
    - AppTokenCredential for environment-aware Azure authentication
    - ReplaceKeyVaultReferences for @KeyVault() syntax support
    - Fluent API for DI registration
    - Comprehensive XML documentation
    - Full test coverage for Key Vault replacement
  </done>
</task>

</tasks>

<verification>
1. Solution builds: `dotnet build Imagile.Framework.sln`
2. All tests pass: `dotnet test`
3. Package creates: `dotnet pack src/Imagile.Framework.Configuration`
4. Fluent API is chainable: Check return types
5. XML documentation complete: No CS1591 warnings
</verification>

<success_criteria>
- AddFrameworkConfiguration() available as extension on IServiceCollection
- WithKeyVault() triggers Key Vault replacement and registers SecretClient
- WithValidation() documented (consumers use ValidateOnStart per-options)
- All methods chainable (return builder or services)
- Package builds and packs successfully
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-abstractions/05-03-SUMMARY.md`
</output>
