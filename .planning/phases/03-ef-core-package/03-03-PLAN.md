---
phase: 03-ef-core-package
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs
  - src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeProperty.cs
  - src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeOperation.cs
autonomous: true

must_haves:
  truths:
    - "EntityChange records who changed what entity and when"
    - "EntityChangeProperty records old and new values for individual properties"
    - "TransactionUnique groups changes within same SaveChanges call"
    - "EntityChangeOperation enum distinguishes Create, Update, Delete operations"
  artifacts:
    - path: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs"
      provides: "Header entity for change tracking (who, when, what entity)"
      exports: ["EntityChange"]
      contains: "TransactionUnique"
      min_lines: 50
    - path: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeProperty.cs"
      provides: "Detail entity for property-level changes (old/new values)"
      exports: ["EntityChangeProperty"]
      contains: "OriginalValue"
      min_lines: 40
    - path: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeOperation.cs"
      provides: "Enum for change operation types"
      exports: ["EntityChangeOperation"]
      contains: "Create"
      min_lines: 15
  key_links:
    - from: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs"
      to: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeProperty.cs"
      via: "navigation property"
      pattern: "ICollection<EntityChangeProperty>"
    - from: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs"
      to: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeOperation.cs"
      via: "property type"
      pattern: "EntityChangeOperation"
---

<objective>
Create the entity models for storing audit change history.

Purpose: Provide the persistence layer for property-level change tracking. The two-table design (EntityChange header + EntityChangeProperty details) enables efficient querying - find all changes to an entity, or drill down to specific property changes.

Output: EntityChange entity (header), EntityChangeProperty entity (details), and EntityChangeOperation enum.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ef-core-package/03-CONTEXT.md
@.planning/phases/03-ef-core-package/03-RESEARCH.md

# Prior plan for interface context:
@.planning/phases/03-ef-core-package/03-01-SUMMARY.md

# EF Core project reference:
@src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EntityChangeOperation enum</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeOperation.cs</files>
  <action>
Create the enum defining the type of change operation.

Implementation:
```csharp
namespace Imagile.Framework.EntityFrameworkCore.Entities;

/// <summary>
/// Specifies the type of change operation recorded in an EntityChange.
/// </summary>
public enum EntityChangeOperation
{
    /// <summary>
    /// A new entity was created (INSERT operation).
    /// </summary>
    Create = 1,

    /// <summary>
    /// An existing entity was modified (UPDATE operation).
    /// </summary>
    Update = 2,

    /// <summary>
    /// An entity was deleted. For soft-deleted entities, this is recorded when IsDeleted changes to true.
    /// </summary>
    Delete = 3
}
```

Create the Entities directory if it doesn't exist.
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>EntityChangeOperation enum exists with Create, Update, Delete values</done>
</task>

<task type="auto">
  <name>Task 2: Create EntityChange entity</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs</files>
  <action>
Create the header entity that records who changed what entity and when.

Based on Arcoro.One pattern with:
- TransactionUnique to group related changes
- Generic TUserKey for flexibility
- Parent entity tracking for hierarchical audits

Implementation:
```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Imagile.Framework.EntityFrameworkCore.Entities;

/// <summary>
/// Records a change event for an entity. Serves as the header for property-level change details.
/// </summary>
/// <typeparam name="TUserKey">The type of the user identifier (e.g., int, Guid, string)</typeparam>
/// <remarks>
/// <para>
/// Each EntityChange represents a single entity being created, updated, or deleted within a SaveChanges call.
/// Multiple EntityChange records may share the same TransactionUnique when multiple entities are
/// modified in the same SaveChanges operation.
/// </para>
/// <para>
/// Property-level changes are stored in related EntityChangeProperty records. Query the Properties
/// collection to see what specific values changed.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// // Query changes for a specific entity
/// var changes = await context.EntityChanges
///     .Where(c => c.EntityName == "Customer" &amp;&amp; c.ItemId == customerId)
///     .Include(c => c.Properties)
///     .OrderByDescending(c => c.ChangedOn)
///     .ToListAsync();
/// </code>
/// </example>
public class EntityChange<TUserKey>
{
    /// <summary>
    /// Gets or sets the primary key for this change record.
    /// </summary>
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// Gets or sets the unique identifier grouping changes within the same SaveChanges call.
    /// </summary>
    /// <remarks>
    /// Use this to find all entities modified in the same transaction.
    /// A new Guid is generated for each SaveChanges invocation.
    /// </remarks>
    public Guid TransactionUnique { get; set; }

    /// <summary>
    /// Gets or sets the correlation identifier from the audit context.
    /// </summary>
    /// <remarks>
    /// Links audit records to distributed tracing. Typically the HTTP request TraceIdentifier.
    /// May span multiple SaveChanges calls within the same request.
    /// </remarks>
    public Guid? CorrelationId { get; set; }

    /// <summary>
    /// Gets or sets the database table name for the changed entity.
    /// </summary>
    [Required]
    [MaxLength(256)]
    public string TableName { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the CLR type name of the changed entity.
    /// </summary>
    [Required]
    [MaxLength(256)]
    public string EntityName { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the primary key value of the changed entity.
    /// </summary>
    /// <remarks>
    /// For newly created entities with auto-generated keys, this is populated
    /// after the initial SaveChanges completes and the key is generated.
    /// </remarks>
    public int? ItemId { get; set; }

    /// <summary>
    /// Gets or sets the type of change operation (Create, Update, Delete).
    /// </summary>
    public EntityChangeOperation Operation { get; set; }

    /// <summary>
    /// Gets or sets the UTC timestamp when this change was recorded.
    /// </summary>
    public DateTimeOffset ChangedOn { get; set; }

    /// <summary>
    /// Gets or sets the user identifier who made this change.
    /// </summary>
    /// <remarks>
    /// Populated from IAuditContextProvider.UserId. May be null for system-generated changes.
    /// </remarks>
    public TUserKey? ChangedBy { get; set; }

    /// <summary>
    /// Gets or sets a human-readable description of the change.
    /// </summary>
    /// <remarks>
    /// Populated from IEntityChangeAuditable.EntityChangeDescription if the entity provides one.
    /// For example: "Invoice #1234" or "Customer: Acme Corp".
    /// </remarks>
    [MaxLength(500)]
    public string? Description { get; set; }

    /// <summary>
    /// Gets or sets the parent entity type name for hierarchical tracking.
    /// </summary>
    /// <remarks>
    /// Used to group child entity changes with their parent.
    /// For example, OrderLine changes might have ParentEntityName = "Order".
    /// </remarks>
    [MaxLength(256)]
    public string? ParentEntityName { get; set; }

    /// <summary>
    /// Gets or sets the parent entity's primary key.
    /// </summary>
    public int? ParentItemId { get; set; }

    /// <summary>
    /// Gets or sets the collection of property-level changes for this entity.
    /// </summary>
    public virtual ICollection<EntityChangeProperty> Properties { get; set; } = new List<EntityChangeProperty>();
}
```
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>EntityChange entity exists with TransactionUnique, EntityName, ItemId, Operation, ChangedOn, ChangedBy, and Properties collection</done>
</task>

<task type="auto">
  <name>Task 3: Create EntityChangeProperty entity</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeProperty.cs</files>
  <action>
Create the detail entity that records old and new values for individual properties.

Implementation:
```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace Imagile.Framework.EntityFrameworkCore.Entities;

/// <summary>
/// Records the old and new values for a property change within an EntityChange.
/// </summary>
/// <remarks>
/// <para>
/// Each EntityChangeProperty represents one property that changed on an entity.
/// The OriginalValue and NewValue are stored as strings using ToString() or custom formatting.
/// </para>
/// <para>
/// For properties marked with [Auditable(hideValueChanges: true)], the values will contain
/// "[HIDDEN]" instead of actual data, indicating a change occurred without exposing sensitive values.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// // Find salary changes for a specific employee
/// var salaryChanges = await context.Set&lt;EntityChangeProperty&gt;()
///     .Include(p => p.EntityChange)
///     .Where(p => p.PropertyName == "Salary"
///         &amp;&amp; p.EntityChange.EntityName == "Employee"
///         &amp;&amp; p.EntityChange.ItemId == employeeId)
///     .OrderByDescending(p => p.EntityChange.ChangedOn)
///     .Select(p => new {
///         p.OriginalValue,
///         p.NewValue,
///         p.EntityChange.ChangedOn,
///         p.EntityChange.ChangedBy
///     })
///     .ToListAsync();
/// </code>
/// </example>
public class EntityChangeProperty
{
    /// <summary>
    /// Gets or sets the primary key for this property change record.
    /// </summary>
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    /// <summary>
    /// Gets or sets the foreign key to the parent EntityChange.
    /// </summary>
    public int EntityChangeId { get; set; }

    /// <summary>
    /// Gets or sets the parent EntityChange this property belongs to.
    /// </summary>
    [ForeignKey(nameof(EntityChangeId))]
    public virtual EntityChange<object>? EntityChange { get; set; }

    /// <summary>
    /// Gets or sets the name of the property that changed.
    /// </summary>
    /// <remarks>
    /// The CLR property name (e.g., "FirstName"), not the database column name.
    /// </remarks>
    [Required]
    [MaxLength(256)]
    public string PropertyName { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the database column name for this property.
    /// </summary>
    /// <remarks>
    /// May differ from PropertyName if column name is explicitly configured.
    /// Useful for correlating with raw SQL queries or database logs.
    /// </remarks>
    [MaxLength(256)]
    public string? ColumnName { get; set; }

    /// <summary>
    /// Gets or sets the value before the change, formatted as a string.
    /// </summary>
    /// <remarks>
    /// <para>Null for newly created entities (Create operation).</para>
    /// <para>Contains "[HIDDEN]" for properties with Auditable(hideValueChanges: true).</para>
    /// <para>Formatted using DisplayFormatAttribute if present, otherwise ToString().</para>
    /// </remarks>
    public string? OriginalValue { get; set; }

    /// <summary>
    /// Gets or sets the value after the change, formatted as a string.
    /// </summary>
    /// <remarks>
    /// <para>Null for deleted entities (Delete operation).</para>
    /// <para>Contains "[HIDDEN]" for properties with Auditable(hideValueChanges: true).</para>
    /// <para>Formatted using DisplayFormatAttribute if present, otherwise ToString().</para>
    /// </remarks>
    public string? NewValue { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether actual values are hidden.
    /// </summary>
    /// <remarks>
    /// True when the property is marked with [Auditable(hideValueChanges: true)].
    /// When true, OriginalValue and NewValue contain "[HIDDEN]" instead of actual values.
    /// </remarks>
    public bool AreValuesHidden { get; set; }
}
```

Note: The EntityChange navigation property uses `object` as the generic type to avoid
complex generic constraints. The actual relationship is managed by EntityChangeId.
In a real DbContext configuration, this will be properly set up with the correct TUserKey.
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>EntityChangeProperty entity exists with EntityChangeId, PropertyName, ColumnName, OriginalValue, NewValue, AreValuesHidden properties</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Imagile.Framework.sln --no-restore` succeeds with no errors
- [ ] EntityChangeOperation enum exists with Create, Update, Delete values
- [ ] EntityChange entity has all required properties (TransactionUnique, EntityName, ItemId, Operation, etc.)
- [ ] EntityChange has navigation property to ICollection<EntityChangeProperty>
- [ ] EntityChangeProperty has foreign key relationship to EntityChange
- [ ] EntityChangeProperty has OriginalValue, NewValue, AreValuesHidden
- [ ] All entities have comprehensive XML documentation
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Two-table design correctly established (header + details)
- Generic TUserKey on EntityChange for flexibility
- Proper foreign key relationship between entities
- AreValuesHidden flag supports sensitive data tracking
</success_criteria>

<output>
After completion, create `.planning/phases/03-ef-core-package/03-03-SUMMARY.md`
</output>
