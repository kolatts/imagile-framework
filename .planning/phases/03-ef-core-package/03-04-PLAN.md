---
phase: 03-ef-core-package
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs
  - src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
autonomous: true

must_haves:
  truths:
    - "ImagileDbContext automatically populates CreatedOn/ModifiedOn timestamps"
    - "ImagileDbContext automatically populates CreatedBy/ModifiedBy from audit context"
    - "ImagileDbContext automatically tracks soft delete (IsDeleted, DeletedOn, DeletedBy)"
    - "ImagileDbContext creates EntityChange records for IEntityChangeAuditable entities"
    - "SaveChanges pattern prevents recursive infinite loop"
  artifacts:
    - path: "src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs"
      provides: "Base DbContext with audit logging in SaveChanges override"
      exports: ["ImagileDbContext"]
      contains: "SaveChangesAsync"
      min_lines: 150
  key_links:
    - from: "src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs"
      to: "src/Imagile.Framework.Core/Interfaces/IAuditContextProvider.cs"
      via: "constructor injection"
      pattern: "IAuditContextProvider"
    - from: "src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs"
      to: "src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs"
      via: "DbSet property"
      pattern: "DbSet<EntityChange"
    - from: "src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs"
      to: "src/Imagile.Framework.EntityFrameworkCore/Interfaces/IAuditableEntity.cs"
      via: "ChangeTracker.Entries filter"
      pattern: "Entries<IAuditableEntity"
---

<objective>
Create the base DbContext with SaveChanges override for automatic audit logging.

Purpose: Provide the central audit functionality that automatically tracks timestamps, users, soft deletes, and property-level changes. Developers inherit from this base class to get audit capabilities without writing boilerplate.

Output: ImagileDbContext abstract base class with SaveChanges/SaveChangesAsync overrides implementing the audit pattern from Arcoro.One.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ef-core-package/03-CONTEXT.md
@.planning/phases/03-ef-core-package/03-RESEARCH.md

# Prior plan summaries for interfaces and entities:
@.planning/phases/03-ef-core-package/03-01-SUMMARY.md
@.planning/phases/03-ef-core-package/03-02-SUMMARY.md
@.planning/phases/03-ef-core-package/03-03-SUMMARY.md

# EF Core project and interfaces:
@src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
@src/Imagile.Framework.EntityFrameworkCore/Interfaces/ITimestampedEntity.cs
@src/Imagile.Framework.EntityFrameworkCore/Interfaces/IAuditableEntity.cs
@src/Imagile.Framework.EntityFrameworkCore/Interfaces/IEntityChangeAuditable.cs
@src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChange.cs
@src/Imagile.Framework.EntityFrameworkCore/Entities/EntityChangeProperty.cs
@src/Imagile.Framework.EntityFrameworkCore/Attributes/AuditableAttribute.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Microsoft.EntityFrameworkCore.Relational package reference</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj</files>
  <action>
Add the Relational package reference needed for accessing metadata like GetTableName(), GetColumnName().

Update the project file to add the package reference:

```xml
<ItemGroup>
  <PackageReference Include="Microsoft.EntityFrameworkCore" />
  <PackageReference Include="Microsoft.EntityFrameworkCore.Relational" />
</ItemGroup>
```

The version will come from Directory.Packages.props (Central Package Management).
  </action>
  <verify>dotnet restore src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj</verify>
  <done>Microsoft.EntityFrameworkCore.Relational package reference added to project</done>
</task>

<task type="auto">
  <name>Task 2: Create ImagileDbContext base class</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/DbContext/ImagileDbContext.cs</files>
  <action>
Create the base DbContext with SaveChanges override implementing the Arcoro.One audit pattern.

**Reference:** See 03-RESEARCH.md for detailed patterns and code examples.

**Class Structure:**
- Abstract class: `ImagileDbContext<TUserKey, TTenantKey> : DbContext`
- Protected property: `IAuditContextProvider<TUserKey, TTenantKey> AuditContext`
- Public DbSets: `EntityChange<TUserKey>`, `EntityChangeProperty`

**SaveChanges Pattern (from Arcoro.One - see RESEARCH.md "Pattern 2"):**
1. Generate `transactionUnique = Guid.NewGuid()` and `now = DateTimeOffset.UtcNow`
2. BEFORE base.SaveChanges: Call `CaptureEntityChanges()` for IEntityChangeAuditable entities
3. BEFORE base.SaveChanges: Call `PopulateAuditFields()` for all audit interfaces
4. Call `base.SaveChangesAsync()` - entities written to DB, auto-generated keys populated
5. AFTER base.SaveChanges: Call `SaveEntityChangesAsync()` - now ItemIds are available

**PopulateAuditFields method:**
- For ITimestampedEntity: Set CreatedOn/ModifiedOn based on EntityState
- For IAuditableEntity<TUserKey>: Set CreatedBy/ModifiedBy from AuditContext.UserId
- For IAuditableEntity<TUserKey>: Detect soft delete transition (IsDeleted false->true), populate DeletedOn/DeletedBy
- For ITenantEntity<TTenantKey>: Set TenantId from AuditContext.TenantId on Added state
- Use reflection to handle generic interface matching

**CaptureEntityChanges method:**
- Filter ChangeTracker.Entries() for IEntityChangeAuditable entities
- Create EntityChange record with: TransactionUnique, CorrelationId, TableName, EntityName, Operation, ChangedOn, ChangedBy
- Determine operation: Added->Create, Deleted->Delete, Modified->Update (or Delete if soft delete transition)
- Call CapturePropertyChanges for property-level details
- Capture temporary properties for auto-generated keys

**CapturePropertyChanges method:**
- Iterate entry.Properties, skip primary keys
- Only track properties with [Auditable] attribute (see RESEARCH.md "Pattern 3")
- For updates, only track modified properties
- Create EntityChangeProperty with PropertyName, ColumnName, OriginalValue, NewValue
- If HideValueChanges=true, use "[HIDDEN]" constant instead of actual values

**FormatValue method:**
- Handle null, DisplayFormatAttribute, DateTimeOffset, DateTime, decimal, etc.
- Use CultureInfo.InvariantCulture for consistent formatting

**SaveEntityChangesAsync method:**
- Populate ItemIds from temporary properties (see RESEARCH.md "Pattern 5")
- Add EntityChange records to DbSet
- Call base.SaveChangesAsync() for second save

**OnModelCreating:**
- Configure EntityChanges table with indexes on TransactionUnique, (EntityName, ItemId), ChangedOn
- Configure EntityChangeProperties table with foreign key to EntityChange

Create DbContext directory if needed.
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>ImagileDbContext base class exists with SaveChanges/SaveChangesAsync overrides implementing automatic audit logging</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Imagile.Framework.sln --no-restore` succeeds with no errors
- [ ] Microsoft.EntityFrameworkCore.Relational package reference added
- [ ] ImagileDbContext is abstract with TUserKey, TTenantKey generic parameters
- [ ] SaveChanges and SaveChangesAsync override base methods
- [ ] PopulateAuditFields handles ITimestampedEntity, IAuditableEntity, ITenantEntity
- [ ] CaptureEntityChanges creates EntityChange records for IEntityChangeAuditable entities
- [ ] CapturePropertyChanges respects [Auditable] attribute and HideValueChanges
- [ ] SaveEntityChangesAsync handles temporary values for auto-generated keys
- [ ] OnModelCreating configures EntityChange tables with appropriate indexes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- SaveChanges pattern matches Arcoro.One (capture BEFORE, save AFTER)
- No recursive SaveChanges infinite loop
- Soft delete transition detected and handled
- Generic type parameters enable flexibility
</success_criteria>

<output>
After completion, create `.planning/phases/03-ef-core-package/03-04-SUMMARY.md`
</output>
