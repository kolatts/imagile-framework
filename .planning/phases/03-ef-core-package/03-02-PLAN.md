---
phase: 03-ef-core-package
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Imagile.Framework.EntityFrameworkCore/Attributes/AuditableAttribute.cs
  - src/Imagile.Framework.EntityFrameworkCore/Attributes/IgnoreAuditAttribute.cs
autonomous: true

must_haves:
  truths:
    - "Developer can mark properties with [Auditable] to enable property-level change tracking (EF-07 property-level opt-in)"
    - "Developer can mark properties with [IgnoreAudit] to exclude from change tracking"
    - "[Auditable(hideValueChanges: true)] records that a change occurred without storing actual values"
    - "Attributes are foundational - entity-level opt-in is via IEntityChangeAuditable interface (Plan 01)"
  artifacts:
    - path: "src/Imagile.Framework.EntityFrameworkCore/Attributes/AuditableAttribute.cs"
      provides: "Attribute to mark properties for change tracking"
      exports: ["AuditableAttribute"]
      contains: "AttributeTargets.Property"
      min_lines: 25
    - path: "src/Imagile.Framework.EntityFrameworkCore/Attributes/IgnoreAuditAttribute.cs"
      provides: "Attribute to exclude properties from change tracking"
      exports: ["IgnoreAuditAttribute"]
      contains: "AttributeTargets.Property"
      min_lines: 15
  key_links: []
---

<objective>
Create the attribute system for opt-in property-level change tracking.

Purpose: Enable selective property tracking where developers explicitly mark which properties should have their changes recorded. This prevents noise from tracking every property and allows hiding sensitive values (like password hashes) while still recording that a change occurred.

Output: Two attributes - AuditableAttribute for opt-in and IgnoreAuditAttribute for explicit exclusion.

**EF-07 Opt-in Clarification:** The [Auditable] attribute provides PROPERTY-level opt-in for change tracking. ENTITY-level opt-in is achieved by implementing IEntityChangeAuditable interface (Plan 01). Both are required: entity must implement interface AND properties must have attribute.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ef-core-package/03-CONTEXT.md
@.planning/phases/03-ef-core-package/03-RESEARCH.md

# Core package attribute patterns (for reference):
@src/Imagile.Framework.Core/Attributes/AssociatedAttribute.cs
@src/Imagile.Framework.Core/Attributes/DoNotUpdateAttribute.cs

# EF Core project structure:
@src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AuditableAttribute</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Attributes/AuditableAttribute.cs</files>
  <action>
Create the attribute for marking properties to be tracked in EntityChangeProperty records.

Based on Arcoro.One EntityChangeAuditableAttribute pattern:
- Applied to properties
- Optional HideValueChanges flag for sensitive data (tracks change occurred, hides actual values)

Implementation:
```csharp
namespace Imagile.Framework.EntityFrameworkCore.Attributes;

/// <summary>
/// Marks a property for inclusion in property-level change tracking.
/// Only properties marked with this attribute will be recorded in EntityChangeProperty.
/// </summary>
/// <remarks>
/// <para>
/// Apply this attribute to properties on entities implementing IEntityChangeAuditable.
/// When the property value changes, the old and new values are recorded in an EntityChangeProperty record.
/// </para>
/// <para>
/// For sensitive data like passwords or tokens, use <c>hideValueChanges: true</c> to record that
/// a change occurred without storing the actual values. This maintains audit trail integrity
/// while protecting sensitive information.
/// </para>
/// <para>
/// Properties without this attribute are not tracked, even on IEntityChangeAuditable entities.
/// This opt-in approach prevents noise from tracking every property and gives developers
/// explicit control over what's audited.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// public class Employee : IEntityChangeAuditable&lt;int&gt;
/// {
///     public int Id { get; set; }
///
///     [Auditable]
///     public string FirstName { get; set; } = string.Empty;
///
///     [Auditable]
///     public string LastName { get; set; } = string.Empty;
///
///     [Auditable]
///     public decimal Salary { get; set; }
///
///     [Auditable(hideValueChanges: true)]  // Records change, hides actual hash
///     public string PasswordHash { get; set; } = string.Empty;
///
///     public string InternalNotes { get; set; } = string.Empty;  // Not tracked
///
///     // IEntityChangeAuditable implementation...
/// }
/// </code>
/// </example>
[AttributeUsage(AttributeTargets.Property, AllowMultiple = false, Inherited = true)]
public sealed class AuditableAttribute : Attribute
{
    /// <summary>
    /// Initializes a new instance of the <see cref="AuditableAttribute"/> class.
    /// </summary>
    /// <param name="hideValueChanges">
    /// When true, records that a change occurred but stores "[HIDDEN]" instead of actual values.
    /// Use for sensitive data like passwords, tokens, or PII that shouldn't appear in audit logs.
    /// </param>
    public AuditableAttribute(bool hideValueChanges = false)
    {
        HideValueChanges = hideValueChanges;
    }

    /// <summary>
    /// Gets a value indicating whether actual values should be hidden in the audit log.
    /// </summary>
    /// <remarks>
    /// When true, EntityChangeProperty.OriginalValue and NewValue will contain "[HIDDEN]"
    /// instead of the actual values. The change is still recorded for audit completeness.
    /// </remarks>
    public bool HideValueChanges { get; }
}
```

Create the Attributes directory if it doesn't exist.
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>AuditableAttribute exists with HideValueChanges property, sealed, AllowMultiple=false, Inherited=true</done>
</task>

<task type="auto">
  <name>Task 2: Create IgnoreAuditAttribute</name>
  <files>src/Imagile.Framework.EntityFrameworkCore/Attributes/IgnoreAuditAttribute.cs</files>
  <action>
Create the attribute for explicitly excluding properties from change tracking.

This provides an alternative to not having [Auditable] - useful for documentation clarity when you want to explicitly mark something as intentionally not tracked.

Implementation:
```csharp
namespace Imagile.Framework.EntityFrameworkCore.Attributes;

/// <summary>
/// Explicitly marks a property as excluded from change tracking.
/// </summary>
/// <remarks>
/// <para>
/// Use this attribute to document that a property is intentionally excluded from audit tracking.
/// While properties without [Auditable] are already not tracked, [IgnoreAudit] makes the
/// exclusion explicit for code clarity and review.
/// </para>
/// <para>
/// Common use cases:
/// <list type="bullet">
///   <item>Computed properties that are derived from other tracked values</item>
///   <item>High-frequency update fields (like LastHeartbeat) that would create audit noise</item>
///   <item>Large binary/blob fields where change tracking would be expensive</item>
///   <item>Navigation properties and collections</item>
/// </list>
/// </para>
/// <para>
/// This is a marker attribute with no effect on behavior - the change tracking system
/// already ignores properties without [Auditable]. It exists for documentation purposes.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// public class Session : IEntityChangeAuditable&lt;int&gt;
/// {
///     public int Id { get; set; }
///
///     [Auditable]
///     public string UserId { get; set; } = string.Empty;
///
///     [Auditable]
///     public string IpAddress { get; set; } = string.Empty;
///
///     [IgnoreAudit]  // Updates every request, would create too much noise
///     public DateTimeOffset LastActivity { get; set; }
///
///     [IgnoreAudit]  // Large blob, expensive to track
///     public byte[]? SessionData { get; set; }
///
///     // IEntityChangeAuditable implementation...
/// }
/// </code>
/// </example>
[AttributeUsage(AttributeTargets.Property, AllowMultiple = false, Inherited = true)]
public sealed class IgnoreAuditAttribute : Attribute
{
    /// <summary>
    /// Initializes a new instance of the <see cref="IgnoreAuditAttribute"/> class.
    /// </summary>
    /// <param name="reason">Optional reason for excluding this property from audit tracking.</param>
    public IgnoreAuditAttribute(string? reason = null)
    {
        Reason = reason;
    }

    /// <summary>
    /// Gets the optional reason why this property is excluded from audit tracking.
    /// </summary>
    /// <remarks>
    /// Provides documentation for code reviewers about why the property is not audited.
    /// For example: "Updates every heartbeat, would create excessive audit records"
    /// </remarks>
    public string? Reason { get; }
}
```
  </action>
  <verify>dotnet build src/Imagile.Framework.EntityFrameworkCore/Imagile.Framework.EntityFrameworkCore.csproj --no-restore</verify>
  <done>IgnoreAuditAttribute exists with optional Reason property, sealed, marker attribute for documentation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Imagile.Framework.sln --no-restore` succeeds with no errors
- [ ] AuditableAttribute exists with HideValueChanges property
- [ ] AuditableAttribute is sealed with AttributeTargets.Property
- [ ] IgnoreAuditAttribute exists with optional Reason property
- [ ] IgnoreAuditAttribute is sealed with AttributeTargets.Property
- [ ] Both attributes have comprehensive XML documentation with examples
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Attributes follow established patterns from Core package
- HideValueChanges enables sensitive data handling
- Documentation clearly explains opt-in vs explicit exclusion
</success_criteria>

<output>
After completion, create `.planning/phases/03-ef-core-package/03-02-SUMMARY.md`
</output>
