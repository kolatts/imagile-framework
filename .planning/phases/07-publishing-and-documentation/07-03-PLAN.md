---
phase: 07-publishing-and-documentation
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - .github/workflows/publish-nuget.yml
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions publishes all 6 packages when version tag is pushed"
    - "CI workflow runs tests before allowing merge"
    - "Symbol packages are published alongside main packages"
  artifacts:
    - path: ".github/workflows/publish-nuget.yml"
      provides: "NuGet publishing workflow"
      contains: "Imagile.Framework.Storage"
    - path: ".github/workflows/ci.yml"
      provides: "CI workflow with tests"
      contains: "dotnet test"
  key_links:
    - from: ".github/workflows/publish-nuget.yml"
      to: "nuget.org"
      via: "dotnet nuget push with API key"
      pattern: "nuget push.*\\.snupkg"
---

<objective>
Update GitHub Actions workflows to publish all 6 packages with symbol packages and ensure CI runs tests.

Purpose: Per phase requirements, all packages need automated publishing with symbol packages. Current workflow only publishes Core, EntityFrameworkCore, and Blazor.ApplicationInsights - missing Configuration and Storage packages.

Output: Updated CI and publish workflows that handle all packages correctly.
</objective>

<execution_context>
@C:\Users\kolat\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kolat\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Code\imagile-framework\.planning\STATE.md
@C:\Code\imagile-framework\.planning\phases\07-publishing-and-documentation\07-CONTEXT.md

# Current workflows
@C:\Code\imagile-framework\.github\workflows\ci.yml
@C:\Code\imagile-framework\.github\workflows\publish-nuget.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CI Workflow to Run Tests</name>
  <files>C:\Code\imagile-framework\.github\workflows\ci.yml</files>
  <action>
Update ci.yml to add test execution step.

**Current state:** Builds solution but does not run tests.

**Add after build step:**
```yaml
    - name: Run tests
      run: dotnet test Imagile.Framework.sln --configuration Release --no-build --verbosity normal
```

**Keep existing structure:**
- Triggered on push/PR to main and develop
- Setup .NET 9.0.x and 10.0.x
- Restore, build, then NEW test step
  </action>
  <verify>ci.yml contains "dotnet test" command. Workflow YAML is valid.</verify>
  <done>CI workflow runs all tests before allowing merge</done>
</task>

<task type="auto">
  <name>Task 2: Update Publish Workflow for All Packages</name>
  <files>C:\Code\imagile-framework\.github\workflows\publish-nuget.yml</files>
  <action>
Update publish-nuget.yml to:

1. **Add test step before publishing:**
```yaml
    - name: Run tests
      run: dotnet test Imagile.Framework.sln --configuration Release --no-build --verbosity normal
```

2. **Add pack steps for missing packages (after existing pack steps):**
```yaml
    - name: Pack Configuration package
      run: dotnet pack src/Imagile.Framework.Configuration/Imagile.Framework.Configuration.csproj --configuration Release --no-build --output ./packages

    - name: Pack Storage package
      run: dotnet pack src/Imagile.Framework.Storage/Imagile.Framework.Storage.csproj --configuration Release --no-build --output ./packages

    - name: Pack EntityFrameworkCore.Testing package
      run: dotnet pack src/Imagile.Framework.EntityFrameworkCore.Testing/Imagile.Framework.EntityFrameworkCore.Testing.csproj --configuration Release --no-build --output ./packages
```

3. **Update NuGet push to include symbol packages:**
   The existing push command uses `*.nupkg` which won't push .snupkg files.

   Change to explicitly push both:
```yaml
    - name: Publish packages to NuGet.org
      run: |
        dotnet nuget push ./packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        dotnet nuget push ./packages/*.snupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
```

4. **Keep existing structure:**
   - Triggered on version tags (v*.*.*)
   - fetch-depth: 0 for GitVersion
   - Setup .NET 10.0.x
  </action>
  <verify>publish-nuget.yml contains pack commands for all 6 packages. Contains test step. Contains snupkg push command. YAML is valid.</verify>
  <done>Publish workflow builds, tests, and publishes all 6 packages with symbol packages</done>
</task>

<task type="auto">
  <name>Task 3: Verify Workflow Syntax</name>
  <files>C:\Code\imagile-framework\.github\workflows\ci.yml, C:\Code\imagile-framework\.github\workflows\publish-nuget.yml</files>
  <action>
Validate both workflow files are syntactically correct.

**Validation steps:**
1. Check YAML syntax is valid (proper indentation, no tabs, correct structure)
2. Verify all `run:` commands are properly formatted
3. Verify multi-line commands use `|` syntax correctly
4. Confirm job names and step names are present
5. Verify secrets reference syntax: `${{ secrets.NUGET_API_KEY }}`

**Common issues to avoid:**
- Mixed tabs and spaces (use spaces only)
- Missing quotes around version strings
- Incorrect indentation (use 2 spaces)
- Missing `run:` key for commands

If any syntax issues found, fix them.
  </action>
  <verify>Run `cat .github/workflows/ci.yml | python -c "import sys, yaml; yaml.safe_load(sys.stdin)"` or equivalent YAML validation. Both files parse without errors.</verify>
  <done>Both workflow files have valid YAML syntax and will execute correctly on GitHub Actions</done>
</task>

</tasks>

<verification>
1. ci.yml includes `dotnet test` step
2. publish-nuget.yml includes:
   - Test step
   - Pack commands for all 6 packages (Core, EntityFrameworkCore, EntityFrameworkCore.Testing, Blazor.ApplicationInsights, Configuration, Storage)
   - Push command for .snupkg files
3. Both YAML files are syntactically valid
4. Workflow structure follows GitHub Actions best practices
</verification>

<success_criteria>
- CI workflow runs tests on every push/PR
- Publish workflow handles all 6 framework packages
- Symbol packages (.snupkg) are published for debugging support
- Workflow syntax is valid and will execute correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-publishing-and-documentation/07-03-SUMMARY.md`
</output>
